

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mmead.molecular.molecules &mdash; MMEA 0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="MMEA 0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> MMEA
          

          
          </a>

          
            
            
              <div class="version">
                0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MMEA</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mmead.molecular.molecules</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mmead.molecular.molecules</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines classes which describe molecules.</span>

<span class="sd">There are a couple of major classes defined here. The most important</span>
<span class="sd">ones are ``StructUnit`` and ``MacroMolecule``. Here is an overview of</span>
<span class="sd">their role/interaction. This is followed by a step-by-step guide to</span>
<span class="sd">macromolecular assembly.</span>

<span class="sd">The StructUnit class represents the monomers that make up</span>
<span class="sd">macromolecules. These are commonly refered to as ``building blocks`` in</span>
<span class="sd">the documentation. The class holds information concerning only a single</span>
<span class="sd">building block molecule. Such as the number of atoms and bonds it may</span>
<span class="sd">have. It also has information about the functoinal groups present on</span>
<span class="sd">the building block molecule (FGInfo class defined in</span>
<span class="sd">/mmea/classes/fg_info.py). The class also allows manipulation of the</span>
<span class="sd">lone building block molecule, such as rotations and translations.</span>

<span class="sd">The StructUnit class should be inherited as necessary. For example</span>
<span class="sd">StructUnit2 adds manipulations relavant to molecules with 2 functional</span>
<span class="sd">groups. The StructUnit3 class adds manipulations relavant to 3 or more</span>
<span class="sd">functional groups. If you have a monomer which needs specific</span>
<span class="sd">information or manipulations, give it its own class.</span>

<span class="sd">The MacroMolecule class represents an assembled macromolecule. It</span>
<span class="sd">requires at least 2 basic pieces of information: which monomers are</span>
<span class="sd">used to assemble the macromolecule and what is the topology/structure</span>
<span class="sd">of the macromolecule.</span>

<span class="sd">The MacroMolecule holds in its `building_blocks` attribute a list of</span>
<span class="sd">StructUnit (or derived classes) instances. These represent the</span>
<span class="sd">monomers which form the macromolecule. Only one StructUnit instance per</span>
<span class="sd">monomer type is held. So if 4 of one type of monomer and 2 of another</span>
<span class="sd">type of monomer form a macromolecule, only 2 StructUnit instances are</span>
<span class="sd">in `building_blocks`.</span>

<span class="sd">In its `topology` attribute a MacroMolecule holds a ``Topology` child</span>
<span class="sd">class instance. This instance is responsible for assembling the</span>
<span class="sd">macromolecule from the building blocks. The building should happen in</span>
<span class="sd">the ``__init__()`` method of the MacroMolecule via the Topology</span>
<span class="sd">instance&#39;s ``build()`` method. The ``build()`` method should place the</span>
<span class="sd">assembled macromoleclue in the `mol` attribute of the MacroMolecule</span>
<span class="sd">instance.</span>

<span class="sd">The StructUnit class labels atoms in the functional groups of the</span>
<span class="sd">building blocks as either ``bonder`` or ``del`` (see its</span>
<span class="sd">documentation). This tells the Topology intance which atoms form bonds</span>
<span class="sd">and which are removed during assembly.</span>

<span class="sd">No need to worry about the metaclasses.</span>

<span class="sd">-------------------------------------------------------</span>
<span class="sd">A more detailed description of macromolecular assembly.</span>
<span class="sd">-------------------------------------------------------</span>
<span class="sd">This is a step-by-step guide of how macromolecular assembly is carried</span>
<span class="sd">out and what the classes do.</span>

<span class="sd">First you create StructUnit instances of the building blocks which make</span>
<span class="sd">up the macromolecule:</span>

<span class="sd">    bb = StructUnit(&#39;/path/to/struct/file.mol2&#39;)</span>

<span class="sd">The StructUnit instances are initialized using paths of molecular</span>
<span class="sd">structure files. (Initializing a StructUnit automatically completes</span>
<span class="sd">steps 1 to 4.)</span>

<span class="sd">    1) Place an rdkit instance of the molecule into the `mol` attribute</span>
<span class="sd">       of the StructUnit.</span>
<span class="sd">    2) Scan the path of the structure file for the name of a functional</span>
<span class="sd">       group. (Alternatively the name of a functional group can be</span>
<span class="sd">       supplied to the initializer).</span>

<span class="sd">What functional groups are recognized by MMEA?</span>
<span class="sd">The module ``/mmea/molecular_tools/fg_info.py`` defines a class called</span>
<span class="sd">FGInfo. Instances of this class are held in the list</span>
<span class="sd">`functional_groups` (also in that module). If you put an FGInfo</span>
<span class="sd">instance in that list, the functional group will be recognized.</span>

<span class="sd">    3) Place the FGInfo instance of the functional group in the</span>
<span class="sd">       `func_grp` attribute of the StructUnit.</span>

<span class="sd">    4) Using the FGInfo instance, tag atoms in the building block as</span>
<span class="sd">       either &#39;bonder&#39; or &#39;del&#39;. &#39;bonder&#39; signifies that the atoms form</span>
<span class="sd">       a bond during macromolecular assembly, while &#39;del&#39; means they</span>
<span class="sd">       are deleted.</span>

<span class="sd">    5) Give the StructUnit instances and the class representing the</span>
<span class="sd">       topology to the macromolecule&#39;s initializer.</span>

<span class="sd">    6) Make an instance of the topology class in the MacroMolecule</span>
<span class="sd">      initializer.</span>

<span class="sd">    7) Run the ``build()`` of the instance generated in 6) during</span>
<span class="sd">       MacroMolecule initialization.</span>

<span class="sd">    8) The ``build()`` will vary depending on the Topology class.</span>
<span class="sd">       However the basic structure is the same (steps 9 - 11).</span>

<span class="sd">    9) Combine the StructUnit rdkit molecules into a single rdkit</span>
<span class="sd">       molecule. Make sure that the building blocks are arranged in the</span>
<span class="sd">       shape of the macromolecule. All the manipulations available via</span>
<span class="sd">       the StructUnit class are useful here to make sure all the</span>
<span class="sd">       building blocks are orientated correctly when forming the</span>
<span class="sd">       macromolecule.</span>

<span class="sd">    10) Create bonds between all the disjoined building block</span>
<span class="sd">        molecules. This is where the tagging done by StructUnit is</span>
<span class="sd">        needed.</span>

<span class="sd">    11) Delete all the atoms tagged for deletion.</span>

<span class="sd">After all this you should have a rdkit instance of the macromolecule</span>
<span class="sd">which should be placed in the `mol` attribute of the MacroMolecule</span>
<span class="sd">intance.</span>

<span class="sd">Extending MMEA: Adding new macromolecules.</span>
<span class="sd">------------------------------------------</span>
<span class="sd">To add new macromolecules create a new class which inherits</span>
<span class="sd">``MacroMolecule``. The initializer of ``MacroMolecule`` can be used or</span>
<span class="sd">a custom one may be used. However, all the same attributes must be</span>
<span class="sd">defined.</span>

<span class="sd">If you&#39;re adding a new class of macromolecules, it quite likely you</span>
<span class="sd">want to add a new ``Topology`` class. See the docstring of the</span>
<span class="sd">/mmea/molecular_tools/topologies/base.py module for guidance on adding</span>
<span class="sd">these. The topology class does the assembly of the macromolecule from</span>
<span class="sd">the building blocks. The assembled macromolecule instance is then held</span>
<span class="sd">by the macromolecular class.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">import</span> <span class="nn">rdkit.Geometry.rdGeometry</span> <span class="k">as</span> <span class="nn">rdkit_geo</span>
<span class="kn">import</span> <span class="nn">rdkit.Chem.AllChem</span> <span class="k">as</span> <span class="nn">rdkit</span>

<span class="kn">from</span> <span class="nn">rdkit</span> <span class="k">import</span> <span class="n">DataStructs</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">total_ordering</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="k">import</span> <span class="n">euclidean</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="k">import</span> <span class="n">euclidean_distances</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">ChainMap</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">signature</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">topologies</span>
<span class="kn">from</span> <span class="nn">.fg_info</span> <span class="k">import</span> <span class="n">functional_groups</span>
<span class="kn">from</span> <span class="nn">.energy</span> <span class="k">import</span> <span class="n">Energy</span>
<span class="kn">from</span> <span class="nn">..addons.pyWINDOW</span> <span class="k">import</span> <span class="n">pywindow</span> <span class="k">as</span> <span class="n">pywindow</span>
<span class="kn">from</span> <span class="nn">..convenience_tools</span> <span class="k">import</span> <span class="p">(</span><span class="n">flatten</span><span class="p">,</span> <span class="n">periodic_table</span><span class="p">,</span>
                                 <span class="n">normalize_vector</span><span class="p">,</span> <span class="n">rotation_matrix</span><span class="p">,</span>
                                 <span class="n">vector_theta</span><span class="p">,</span> <span class="n">mol_from_mae_file</span><span class="p">,</span>
                                 <span class="n">rotation_matrix_arbitrary_axis</span><span class="p">,</span>
                                 <span class="n">atom_vdw_radii</span><span class="p">,</span> <span class="n">bond_dict</span><span class="p">)</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Cached"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Cached">[docs]</a><span class="k">class</span> <span class="nc">Cached</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A metaclass for creating classes which create cached instances.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">sig</span><span class="o">.</span><span class="n">apply_defaults</span><span class="p">()</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">arguments</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_key</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="s1">&#39;building_blocks&#39;</span><span class="p">],</span> <span class="n">sig</span><span class="p">[</span><span class="s1">&#39;topology&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="CachedStructUnit"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.CachedStructUnit">[docs]</a><span class="k">class</span> <span class="nc">CachedStructUnit</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A metaclass for making StructUnit create cached instances.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Get the arguments given to the initializer as a dictionary</span>
        <span class="c1"># mapping argument name to argument value.</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">sig</span><span class="o">.</span><span class="n">apply_defaults</span><span class="p">()</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">arguments</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span>

        <span class="c1"># Ensure a valid file type was provided.</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_funcs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Unable to initialize from &quot;</span><span class="si">{}</span><span class="s1">&quot; files.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_funcs</span><span class="p">[</span><span class="n">ext</span><span class="p">](</span><span class="n">sig</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span>

        <span class="c1"># Get the name of the functional group provided to the</span>
        <span class="c1"># initializer or get it from the path.</span>
        <span class="k">if</span> <span class="n">sig</span><span class="p">[</span><span class="s1">&#39;functional_group&#39;</span><span class="p">]:</span>
            <span class="n">fg</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="s1">&#39;functional_group&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fg</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">functional_groups</span> <span class="k">if</span>
                                        <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">sig</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_key</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">fg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="Molecule"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule">[docs]</a><span class="k">class</span> <span class="nc">Molecule</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The most basic class representing molecules.</span>

<span class="sd">    This class defines defines the operations which any class</span>
<span class="sd">    describing molecules should inherit or may find useful. Examples of</span>
<span class="sd">    such classes are ``StructUnit`` and ``MacroMolecule``. This calls</span>
<span class="sd">    is unlikely to be useful as in and of itself. It lacks an</span>
<span class="sd">    `__init__()` method because it does not need one. Child classes</span>
<span class="sd">    should define it.</span>

<span class="sd">    It is assumed that child classes will have some basic attributes.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">        A rdkit molecule instance representing the molecule.</span>

<span class="sd">    inchi : str</span>
<span class="sd">        The InChI of the molecule.</span>

<span class="sd">    energy : Energy</span>
<span class="sd">        An instance of the ``Energy`` class. It handles all things</span>
<span class="sd">        energy.</span>

<span class="sd">    optimized : bool</span>
<span class="sd">        Indicates whether a Molecule has been passed through an</span>
<span class="sd">        optimization function or not.</span>

<span class="sd">    name : str (default = &quot;&quot;)</span>
<span class="sd">        A name which can be optionally given to the molecule for easy</span>
<span class="sd">        identification.</span>

<span class="sd">    note : str (default = &quot;&quot;)</span>
<span class="sd">        A note or comment about the molecule. Purely optional but can</span>
<span class="sd">        be useful for labelling and debugging.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">Energy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">note</span>

<div class="viewcode-block" id="Molecule.all_atom_coords"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.all_atom_coords">[docs]</a>    <span class="k">def</span> <span class="nf">all_atom_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yields the coordinates of atoms in `mol`.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        tuple of (int, numpy.array)</span>
<span class="sd">            The ``int`` represents the atom id of the atom whose</span>
<span class="sd">            coordinates are being yielded.</span>

<span class="sd">            The array represents the position.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the conformer from the rdkit instance.</span>
        <span class="n">conformer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>

        <span class="c1"># Go through all the atoms and ask the conformer to return</span>
        <span class="c1"># the position of each atom. This is done by supplying the</span>
        <span class="c1"># conformers `GetAtomPosition` method with the atom&#39;s id.</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">atom_id</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
            <span class="n">atom_position</span> <span class="o">=</span> <span class="n">conformer</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">atom_id</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">atom_position</span><span class="p">])</span></div>

<div class="viewcode-block" id="Molecule.atom_coords"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.atom_coords">[docs]</a>    <span class="k">def</span> <span class="nf">atom_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return coordinates of an atom.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom_id : int</span>
<span class="sd">            The id of the atom whose coordinates are desired.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            An array holding the x, y and z coordinates of the atom.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>
        <span class="n">atom_position</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">atom_position</span><span class="p">])</span></div>

<div class="viewcode-block" id="Molecule.atom_distance"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.atom_distance">[docs]</a>    <span class="k">def</span> <span class="nf">atom_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom1_id</span><span class="p">,</span> <span class="n">atom2_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the distance between 2 atoms.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom1_id : int</span>
<span class="sd">            The id of the first atom.</span>

<span class="sd">        atom2_id : int</span>
<span class="sd">            The id of the second atom.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scipy.double</span>
<span class="sd">            The distance between the first and second atoms.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the atomic positions of each atom and use the scipy</span>
        <span class="c1"># function to calculate their distance in Euclidean space.</span>
        <span class="n">atom1_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="n">atom1_id</span><span class="p">)</span>
        <span class="n">atom2_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="n">atom2_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">euclidean</span><span class="p">(</span><span class="n">atom1_coords</span><span class="p">,</span> <span class="n">atom2_coords</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.atom_symbol"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.atom_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">atom_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the symbol of the atom with id `atom_id`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom_id : int</span>
<span class="sd">            The id number of the atom.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The atomic symbol of the atom.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)</span>
        <span class="n">atomic_num</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">periodic_table</span><span class="p">[</span><span class="n">atomic_num</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_cavity_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates diameter of the molecule&#39;s from `origin`.</span>

<span class="sd">        The cavity is measured by finding the atom nearest to</span>
<span class="sd">        `origin`, correcting for van der Waals diameter and multiplying</span>
<span class="sd">        by -2.</span>

<span class="sd">        This function should not be used. Use cavity_size() instead.</span>
<span class="sd">        cavity_size() finds the optimal value of `origin` to use.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin : numpy.array</span>
<span class="sd">            Holds the x, y and z coordinate of the position from which</span>
<span class="sd">            the cavity is measured.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The (negative) diameter of the molecules cavity.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">atom_vdw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">atom_vdw_radii</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()]</span> <span class="k">for</span> <span class="n">x</span>
                            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()])</span>

        <span class="n">distances</span> <span class="o">=</span> <span class="n">euclidean_distances</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">origin</span><span class="p">))</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">atom_vdw</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>

<div class="viewcode-block" id="Molecule.cavity_size"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.cavity_size">[docs]</a>    <span class="k">def</span> <span class="nf">cavity_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the diameter of the molecule&#39;s cavity.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The diameter of the molecule&#39;s cavity in Angstroms.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># This function uses _cavity_size() to calculate the cavity</span>
        <span class="c1"># size. _cavity_size() finds the closest atom to `origin` to</span>
        <span class="c1"># get its value of the cavity.</span>

        <span class="c1"># What this function does is finds the value of `origin` which</span>
        <span class="c1"># causes _cavity_size() to calculate the largest possible</span>
        <span class="c1"># cavity.</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">()</span>
        <span class="n">icavity</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_cavity_size</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">coord</span><span class="o">+</span><span class="n">icavity</span><span class="p">,</span> <span class="n">coord</span><span class="o">-</span><span class="n">icavity</span><span class="p">)</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">ref</span><span class="p">]</span>
        <span class="n">cavity_origin</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cavity_size</span><span class="p">,</span>
                                 <span class="n">x0</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
                                 <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span><span class="o">.</span><span class="n">x</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_cavity_size</span><span class="p">(</span><span class="n">cavity_origin</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.center_of_mass"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.center_of_mass">[docs]</a>    <span class="k">def</span> <span class="nf">center_of_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the centre of mass of the molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            An array holding the coordinates of the center of mass.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        https://en.wikipedia.org/wiki/Center_of_mass</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">])</span>
        <span class="n">total_mass</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">atom_id</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_atom_coords</span><span class="p">():</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)</span><span class="o">.</span><span class="n">GetMass</span><span class="p">()</span>
            <span class="n">total_mass</span> <span class="o">+=</span> <span class="n">mass</span>
            <span class="n">center</span> <span class="o">+=</span>  <span class="n">mass</span><span class="o">*</span><span class="n">coord</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">total_mass</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.centroid"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.centroid">[docs]</a>    <span class="k">def</span> <span class="nf">centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the centroid of the molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            A numpy array holding the position of the centroid.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">centroid</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_atom_coords</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">centroid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">())</span></div>

<div class="viewcode-block" id="Molecule.dump"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a JSON dict of the molecule to a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The full path of the file to which the JSON dict of the</span>
<span class="sd">            molecule can be written.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.fromdict"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.fromdict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_dict</span><span class="p">,</span> <span class="n">optimized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_names</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Molecule from a JSON dict.</span>

<span class="sd">        The Molecule returned has the class specified in the JSON</span>
<span class="sd">        dictionary, not ``Molecule``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json_dict : dict</span>
<span class="sd">            A dict holding the JSON representation of a molecule.</span>

<span class="sd">        optimized : bool</span>
<span class="sd">            The value passed to the loaded molecules `optimized`</span>
<span class="sd">            attribute.</span>

<span class="sd">        load_names : bool (default = True)</span>
<span class="sd">            If ``True`` then the `name` attribute stored in the JSON</span>
<span class="sd">            objects is loaded. If ``False`` then it&#39;s not.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecule</span>
<span class="sd">            The molecule represented by `json_dict`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the class of the object.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]]</span>
        <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;optimized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimized</span>
        <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;load_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_names</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">_json_init</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.graph"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.graph">[docs]</a>    <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a mathematical graph representing the molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        networkx.Graph</span>
<span class="sd">            A graph where the nodes are the ids of the atoms in the</span>
<span class="sd">            rdkit molecule and the edges are the bonds.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a graph instance and add the atom ids as nodes. Use</span>
        <span class="c1"># the atom ids from each end of a bond to define edges. Do this</span>
        <span class="c1"># for all bonds to account for all edges.</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetBonds</span><span class="p">():</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">GetBeginAtomIdx</span><span class="p">(),</span>
                           <span class="n">bond</span><span class="o">.</span><span class="n">GetEndAtomIdx</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">graph</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inchi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the InChi of the molecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_stereochemistry</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">MolToInchi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>

<div class="viewcode-block" id="Molecule.load"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">optimized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_names</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Molecule from a JSON file.</span>

<span class="sd">        The Molecule returned has the class specified in the JSON</span>
<span class="sd">        dictionary, not ``Molecule``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The full path holding a JSON representation to a molecule.</span>

<span class="sd">        optimized : bool (default = True)</span>
<span class="sd">            The value passed to the loaded molecules `optimized`</span>
<span class="sd">            attribute.</span>

<span class="sd">        load_names : bool (default = True)</span>
<span class="sd">            If ``True`` then the `name` attribute stored in the JSON</span>
<span class="sd">            objects is loaded. If ``False`` then it&#39;s not.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Molecule</span>
<span class="sd">            The molecule held in `path`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">optimized</span><span class="p">,</span> <span class="n">load_names</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.max_diameter"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.max_diameter">[docs]</a>    <span class="k">def</span> <span class="nf">max_diameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the largest distance between 2 atoms in the molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple of form (float, int, int)</span>
<span class="sd">            The float represents the largest inter-atomic distance on</span>
<span class="sd">            the molecule. The ints are the ids of the atoms.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">maxid1</span><span class="p">,</span> <span class="n">maxid2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                              <span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span>
                                <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()),</span> <span class="mi">2</span><span class="p">)),</span>
                             <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_distance</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

        <span class="n">maxd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_distance</span><span class="p">(</span><span class="n">maxid1</span><span class="p">,</span> <span class="n">maxid2</span><span class="p">)</span>
        <span class="n">maxd</span> <span class="o">+=</span> <span class="p">(</span><span class="n">atom_vdw_radii</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_symbol</span><span class="p">(</span><span class="n">maxid1</span><span class="p">)]</span> <span class="o">+</span>
                 <span class="n">atom_vdw_radii</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_symbol</span><span class="p">(</span><span class="n">maxid2</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">maxd</span><span class="p">,</span> <span class="n">maxid1</span><span class="p">,</span> <span class="n">maxid2</span></div>

<div class="viewcode-block" id="Molecule.mdl_mol_block"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.mdl_mol_block">[docs]</a>    <span class="k">def</span> <span class="nf">mdl_mol_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a V3000 mol block of the molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The V3000 mol block representing the molecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">main_string</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;     RDKit          3D</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;  0  0  0  0  0  0  0  0  0  0999 V3000</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;M  V30 BEGIN CTAB</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;M  V30 COUNTS </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> 0 0 0</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;M  V30 BEGIN ATOM</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;!!!ATOM!!!BLOCK!!!HERE!!!</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;M  V30 END ATOM</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;M  V30 BEGIN BOND</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;!!!BOND!!!BLOCK!!!HERE!!!</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;M  V30 END BOND</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;M  V30 END CTAB</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;M  END</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;$$$$</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># id atomic_symbol x y z</span>
        <span class="n">atom_line</span> <span class="o">=</span> <span class="s2">&quot;M  V30 </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2:.4f}</span><span class="s2"> </span><span class="si">{3:.4f}</span><span class="s2"> </span><span class="si">{4:.4f}</span><span class="s2"> 0</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">atom_block</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># id bond_order atom1 atom2</span>
        <span class="n">bond_line</span> <span class="o">=</span> <span class="s2">&quot;M  V30 </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{3}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">bond_block</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">main_string</span> <span class="o">=</span> <span class="n">main_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">(),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumBonds</span><span class="p">())</span>
        <span class="c1"># Kekulize the mol, which means that each aromatic bond is</span>
        <span class="c1"># converted to a single or double. This is necessary because</span>
        <span class="c1"># .mol V3000 only supports integer bonds.</span>
        <span class="n">rdkit</span><span class="o">.</span><span class="n">Kekulize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">atom_id</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
            <span class="n">atom_sym</span> <span class="o">=</span> <span class="n">periodic_table</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()]</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)</span>
            <span class="n">atom_block</span> <span class="o">+=</span> <span class="n">atom_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom_id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">atom_sym</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetBonds</span><span class="p">():</span>
            <span class="n">bond_id</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
            <span class="n">atom1_id</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">GetBeginAtomIdx</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">atom2_id</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">GetEndAtomIdx</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">bond_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">GetBondTypeAsDouble</span><span class="p">())</span>
            <span class="n">bond_block</span> <span class="o">+=</span> <span class="n">bond_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bond_id</span><span class="p">,</span> <span class="n">bond_order</span><span class="p">,</span>
                                           <span class="n">atom1_id</span><span class="p">,</span> <span class="n">atom2_id</span><span class="p">)</span>

        <span class="n">main_string</span> <span class="o">=</span> <span class="n">main_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s2">&quot;!!!ATOM!!!BLOCK!!!HERE!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">atom_block</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">main_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s2">&quot;!!!BOND!!!BLOCK!!!HERE!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bond_block</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.position_matrix"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.position_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">position_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the position of all atoms in the as a matrix.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.matrix</span>
<span class="sd">            The matrix is 3 x n. Each column holds the x, y and z</span>
<span class="sd">            coordinates of an atom. The index of the column corresponds</span>
<span class="sd">            to the id of the atom in the molecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pos_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">atom_id</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
            <span class="n">pos_vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)])</span>
            <span class="n">pos_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_array</span><span class="p">,</span> <span class="n">pos_vect</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">pos_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.same"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.same">[docs]</a>    <span class="k">def</span> <span class="nf">same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if `other` has the same molecular structure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : MacroMolecule</span>
<span class="sd">            The ``MacroMolecule`` instance you are checking has</span>
<span class="sd">            the same structure.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Returns ``True`` if the building blocks and topology</span>
<span class="sd">            of the macromolecules are the same.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inchi</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">inchi</span></div>

<div class="viewcode-block" id="Molecule.rotate"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotates the molecule by `theta` about `axis`.</span>

<span class="sd">        The rotation occurs about the molecular centroid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : float</span>
<span class="sd">            The size of the rotation in radians.</span>

<span class="sd">        axis : numpy.array</span>
<span class="sd">            The axis about which the rotation happens.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The positions of all the atoms are changed due to the</span>
<span class="sd">            rotation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Save the original position.</span>
        <span class="n">og_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span>
        <span class="c1"># Move the centroid of the molecule to the origin, so that the</span>
        <span class="c1"># rotation occurs about this point.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Get the rotation matrix.</span>
        <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">rotation_matrix_arbitrary_axis</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="c1"># Apply the rotation matrix on the position matrix, to get the</span>
        <span class="c1"># new position matrix.</span>
        <span class="n">new_pos_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_matrix</span><span class="p">())</span>
        <span class="c1"># Apply the rotation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position_from_matrix</span><span class="p">(</span><span class="n">new_pos_mat</span><span class="p">)</span>
        <span class="c1"># Return the centroid of the molecule to the origin position.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">og_position</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.save_bonders"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.save_bonders">[docs]</a>    <span class="k">def</span> <span class="nf">save_bonders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds atoms tagged with &#39;bonder&#39; to `bonder_ids`.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        bonder_ids : list of ints</span>
<span class="sd">            Updates this set with the ids of atoms tagged &#39;bonder&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Clear the set in case the method is run twice.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="s1">&#39;bonder&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">())</span></div>

<div class="viewcode-block" id="Molecule.set_orientation"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.set_orientation">[docs]</a>    <span class="k">def</span> <span class="nf">set_orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotates the molecule by a rotation from `start` to `end`.</span>

<span class="sd">        Note: The difference between this method and</span>
<span class="sd">        `_set_orientation2()` is about which point the rotation</span>
<span class="sd">        occurs: centroid of entire molecule versus centroid of bonder</span>
<span class="sd">        atoms, respectively.</span>

<span class="sd">        Given two direction vectors, `start` and `end`, this method</span>
<span class="sd">        applies the rotation required transform `start` to `end` on</span>
<span class="sd">        the molecule. The rotation occurs about the centroid of the</span>
<span class="sd">        molecule.</span>

<span class="sd">        For example, if the `start` and `end` vectors</span>
<span class="sd">        are 45 degrees apart, a 45 degree rotation will be applied to</span>
<span class="sd">        the molecule. The rotation will be along the appropriate</span>
<span class="sd">        direction.</span>

<span class="sd">        The great thing about this method is that you as long as you</span>
<span class="sd">        can associate a gemotric feature of the molecule with a vector,</span>
<span class="sd">        then the molecule can be roatated so that this vector is</span>
<span class="sd">        aligned with `end`. The defined vector can be virtually</span>
<span class="sd">        anything. This means that any geomteric feature of the molecule</span>
<span class="sd">        can be easily aligned with any arbitrary axis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : numpy.array</span>
<span class="sd">            A vector which is to be rotated so that it transforms to</span>
<span class="sd">            the `end` vector.</span>

<span class="sd">        end : numpy.array</span>
<span class="sd">            This array holds the vector, onto which `start` is rotated.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The conformer in this rdkit instance is changed due to</span>
<span class="sd">            rotation of the molecule about its centroid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The rdkit molecule in `mol`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Normalize the input direction vectors.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">normalize_vector</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">normalize_vector</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

        <span class="c1"># Record the position of the molecule then translate the</span>
        <span class="c1"># centroid to the origin. This is so that the rotation occurs</span>
        <span class="c1"># about this point.</span>
        <span class="n">og_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Get the rotation matrix.</span>
        <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="c1"># Apply the rotation matrix to the atomic positions to yield</span>
        <span class="c1"># the new atomic positions.</span>
        <span class="n">new_pos_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_matrix</span><span class="p">())</span>

        <span class="c1"># Set the positions of the molecule.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position_from_matrix</span><span class="p">(</span><span class="n">new_pos_mat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">og_center</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span></div>

<div class="viewcode-block" id="Molecule.set_position"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.set_position">[docs]</a>    <span class="k">def</span> <span class="nf">set_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the centroid of the molecule to `position`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        position : numpy.array</span>
<span class="sd">            This array holds the position on which the centroid of the</span>
<span class="sd">            molecule should be placed.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The conformer in this rdkit instance is changed so that its</span>
<span class="sd">            centroid falls on `position`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The rdkit molecule with the centroid placed at `position`.</span>
<span class="sd">            This is the same instance as that in `mol`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the original centroid.</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span>
        <span class="c1"># Find out how much it needs to shift to reach `position`.</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">position</span> <span class="o">-</span> <span class="n">centroid</span>
        <span class="c1"># Apply the shift and get the resulting rdkit conformer object.</span>
        <span class="n">new_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>

        <span class="c1"># Replace the old rkdit conformer with one where the centroid</span>
        <span class="c1"># is at `position`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">RemoveAllConformers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">AddConformer</span><span class="p">(</span><span class="n">new_conf</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span></div>

<div class="viewcode-block" id="Molecule.set_position_from_matrix"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.set_position_from_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">set_position_from_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos_mat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set atomic positions of the molecule to those in `pos_mat`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos_mat : numpy.array</span>
<span class="sd">            The matrix holds the coordinates on which the atoms of the</span>
<span class="sd">            molecule should be placed.</span>

<span class="sd">            The dimensions are 3 x n. Each column of `pos_mat`</span>
<span class="sd">            represents the coordinates of a single atom. The 1st column</span>
<span class="sd">            sets the coordinate of the atom with id of 0. The next</span>
<span class="sd">            column sets the coordinate of the atom with id 1, and so</span>
<span class="sd">            on.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The coordinates of atoms in this molecule are set to the</span>
<span class="sd">            coordinates in `pos_mat`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord_mat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos_mat</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">rdkit_geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">(</span><span class="n">coord_mat</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                      <span class="n">coord_mat</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                      <span class="n">coord_mat</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">SetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.shift"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.shift">[docs]</a>    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shifts the coordinates of all atoms.</span>

<span class="sd">        This does not modify the molecule. A modified copy is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shift : numpy.array</span>
<span class="sd">            A numpy array holding the value of the shift along each</span>
<span class="sd">            axis.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rdkit.Chem.rdchem.Mol</span>
<span class="sd">            A copy of the molecule where the coordinates have been</span>
<span class="sd">            shifted by `shift`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># The function does not modify the existing conformer, as a</span>
        <span class="c1"># result a new instance is created and used for modification.</span>
        <span class="n">conformer</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">Conformer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">())</span>

        <span class="c1"># For each atom, get the atomic positions from the conformer</span>
        <span class="c1"># and shift them. Create a new geometry instance from these new</span>
        <span class="c1"># coordinate values. The geometry instance is used by rdkit to</span>
        <span class="c1"># store the coordinates of atoms. Finally, set the conformers</span>
        <span class="c1"># atomic position to the values stored in this newly generated</span>
        <span class="c1"># geometry instance.</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>

            <span class="c1"># Remember the id of the atom you are currently using. It</span>
            <span class="c1"># is used to change the position of the correct atom at the</span>
            <span class="c1"># end of the loop.</span>
            <span class="n">atom_id</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>

            <span class="c1"># `atom_position` in an instance holding in the x, y and z</span>
            <span class="c1"># coordinates of an atom in its &#39;x&#39;, &#39;y&#39; and &#39;z&#39;</span>
            <span class="c1"># attributes.</span>
            <span class="n">atom_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                    <span class="n">conformer</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">atom_id</span><span class="p">))</span>

            <span class="c1"># Inducing the shift.</span>
            <span class="n">new_atom_position</span> <span class="o">=</span> <span class="n">atom_position</span> <span class="o">+</span> <span class="n">shift</span>

            <span class="c1"># Creating a new geometry instance.</span>
            <span class="n">new_coords</span> <span class="o">=</span> <span class="n">rdkit_geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">(</span><span class="o">*</span><span class="n">new_atom_position</span><span class="p">)</span>

            <span class="c1"># Changes the position of the atom in the conformer to the</span>
            <span class="c1"># values stored in the new geometry instance.</span>
            <span class="n">conformer</span><span class="o">.</span><span class="n">SetAtomPosition</span><span class="p">(</span><span class="n">atom_id</span><span class="p">,</span> <span class="n">new_coords</span><span class="p">)</span>

        <span class="c1"># Create a new copy of the rdkit molecule instance representing</span>
        <span class="c1"># the molecule - the original instance is not to be modified.</span>
        <span class="n">new_mol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>

        <span class="c1"># The new rdkit molecule was copied from the one held in the</span>
        <span class="c1"># `mol` attribute, as result it has a copy of its conformer. To</span>
        <span class="c1"># prevent the rdkit molecule from holding multiple conformers</span>
        <span class="c1"># the `RemoveAllConformers` method is run first. The shifted</span>
        <span class="c1"># conformer is then given to the rdkit molecule, which is</span>
        <span class="c1"># returned.</span>
        <span class="n">new_mol</span><span class="o">.</span><span class="n">RemoveAllConformers</span><span class="p">()</span>
        <span class="n">new_mol</span><span class="o">.</span><span class="n">AddConformer</span><span class="p">(</span><span class="n">conformer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_mol</span></div>

<div class="viewcode-block" id="Molecule.update_from_mae"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.update_from_mae">[docs]</a>    <span class="k">def</span> <span class="nf">update_from_mae</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mae_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates molecular structure to match an .mae file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mae_path : str</span>
<span class="sd">            The full path of the .mae file from which the structure</span>
<span class="sd">            should be updated.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The rdkit molecule held in this attribute is changed so</span>
<span class="sd">            that it matches the moleclue held in the .mae file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol_from_mae_file</span><span class="p">(</span><span class="n">mae_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.update_stereochemistry"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.update_stereochemistry">[docs]</a>    <span class="k">def</span> <span class="nf">update_stereochemistry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates stereochemistry tags on `mol` attribute.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The &#39;_CIPCode&#39; property on each atom of the rkdit molecule</span>
<span class="sd">            is updated to reflect the R or S configuration of the atom</span>
<span class="sd">            in the current geometry.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">UpdatePropertyCache</span><span class="p">()</span>
        <span class="n">rdkit</span><span class="o">.</span><span class="n">AssignAtomChiralTagsFromStructure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">rdkit</span><span class="o">.</span><span class="n">AssignStereochemistry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.write"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Molecule.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a molecular structure file of the molecule.</span>

<span class="sd">        This bypasses the need to use rdkit&#39;s writing functions, which</span>
<span class="sd">        have issues with macromolecules due to poor ring finding and</span>
<span class="sd">        sanitization issues.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The `path` to which the molecule should be written.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">write_funcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.mol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_mdl_mol_file</span><span class="p">,</span>
                       <span class="s1">&#39;.pdb&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_pdb_file</span><span class="p">}</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">write_func</span> <span class="o">=</span> <span class="n">write_funcs</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
        <span class="n">write_func</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_write_mdl_mol_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a V3000 .mol file of the molecule</span>

<span class="sd">        This function should not be used directly, only via the</span>
<span class="sd">        ``write()`` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The full path to which to the file should be written.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        A file is created/ changed at `path`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdl_mol_block</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_write_pdb_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a .pdb file of the molecule</span>

<span class="sd">        This function should not be used directly, only via the</span>
<span class="sd">        ``write()`` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The full path to which to the file should be written.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        A file is created/ changed at `path`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First write the file using rdkit.</span>
        <span class="n">rdkit</span><span class="o">.</span><span class="n">MolToPDBFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="c1"># Edit the file because rkdit does poor atom labelling.</span>
        <span class="n">new_content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdb</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pdb</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;HETATM&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">lbl_word</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">rpl_word</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">rpl_word</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lbl_word</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">rpl_word</span><span class="p">))</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">lbl_word</span><span class="p">,</span> <span class="n">rpl_word</span><span class="p">)</span>

                <span class="n">new_content</span> <span class="o">+=</span> <span class="n">line</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdb</span><span class="p">:</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_content</span><span class="p">)</span></div>


<div class="viewcode-block" id="StructUnit"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit">[docs]</a><span class="k">class</span> <span class="nc">StructUnit</span><span class="p">(</span><span class="n">Molecule</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">CachedStructUnit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the building blocks of macromolecules examined by MMEA.</span>

<span class="sd">    ``Building blocks`` in this case refers to the smallest molecular</span>
<span class="sd">    units of the assembled molecules examined by MMEA.</span>

<span class="sd">    The goal of this class is to conveniently store information about,</span>
<span class="sd">    and perform operations on, single instances of macromolecular</span>
<span class="sd">    building blocks.</span>

<span class="sd">    An important part of this class is labelling atoms in functional</span>
<span class="sd">    groups.</span>

<span class="sd">    This class should only deal with issues that concern a single</span>
<span class="sd">    building block in and of itself.</span>

<span class="sd">    Class attributes</span>
<span class="sd">    ----------------</span>
<span class="sd">    init_funcs : dict of {str : function}</span>
<span class="sd">        This dictionary holds the various functions which can be used</span>
<span class="sd">        to initialize rdkit molecules and pairs them with the</span>
<span class="sd">        appropriate file extension.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    file : str</span>
<span class="sd">        The full path of the molecular structure file holding the</span>
<span class="sd">        molecule. The supported file formats are the keys in the</span>
<span class="sd">        `init_funcs` dictionary. As long as a file of one of these</span>
<span class="sd">        types is provided, MMEA will automatically use the correct</span>
<span class="sd">        initialization function.</span>

<span class="sd">    mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">        The rdkit instance of the molecule held in `file`.</span>

<span class="sd">    inchi : str</span>
<span class="sd">        The InChI of the molecule.</span>

<span class="sd">    func_grp : FGInfo</span>
<span class="sd">        The ``FGInfo`` instance holding information about the</span>
<span class="sd">        functional group which will react when the building block</span>
<span class="sd">        assembles to form macromolecules.</span>

<span class="sd">    bonder_ids : list of ints</span>
<span class="sd">        A list holding the atom ids of the atoms which form bonds</span>
<span class="sd">        during macromolecular assembly.</span>

<span class="sd">    energy : Energy</span>
<span class="sd">        This attribute handles information about the energy of the</span>
<span class="sd">        instance. See the documentation of ``Energy`` to see what is</span>
<span class="sd">        available.</span>

<span class="sd">    optimized : bool (default = False)</span>
<span class="sd">        A flag to monitor whether an optimization has been performed on</span>
<span class="sd">        the molecule.</span>

<span class="sd">    key : MacroMolKey</span>
<span class="sd">        The key used for caching the molecule.</span>

<span class="sd">    name : str (default = &quot;&quot;)</span>
<span class="sd">        A name which can be optionally given to the molcule for easy</span>
<span class="sd">        identification.</span>

<span class="sd">    note : str (default = &quot;&quot;)</span>
<span class="sd">        A note or comment about the molecule. Purely optional but can</span>
<span class="sd">        be useful for labelling and debugging.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">init_funcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.mol&#39;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="n">rdkit</span><span class="o">.</span><span class="n">MolFromMolFile</span><span class="p">,</span>
                                  <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">removeHs</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>

                  <span class="s1">&#39;.sdf&#39;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="n">rdkit</span><span class="o">.</span><span class="n">MolFromMolFile</span><span class="p">,</span>
                                  <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">removeHs</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>

                  <span class="s1">&#39;.mol2&#39;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="n">rdkit</span><span class="o">.</span><span class="n">MolFromMol2File</span><span class="p">,</span>
                                   <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">removeHs</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>

                  <span class="s1">&#39;.mae&#39;</span><span class="p">:</span> <span class="n">mol_from_mae_file</span><span class="p">,</span>

                  <span class="s1">&#39;.pdb&#39;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="n">rdkit</span><span class="o">.</span><span class="n">MolFromPDBFile</span><span class="p">,</span>
                                  <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">removeHs</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">functional_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a ``StructUnit`` instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : str</span>
<span class="sd">            The full path of the molecular structure file holding the</span>
<span class="sd">            building block.</span>

<span class="sd">        functional_group : str (default = None)</span>
<span class="sd">            The name of the functional group which is to have atoms</span>
<span class="sd">            tagged. If ``None``, a functional group name found in the</span>
<span class="sd">            path `file`  is used. If no functional group is provided</span>
<span class="sd">            to this parameter and the name of one is not present in</span>
<span class="sd">            `file`, no tagging is done.</span>

<span class="sd">        note : str (default = &quot;&quot;)</span>
<span class="sd">            A note or comment about the molecule.</span>

<span class="sd">        name : str (default = &quot;&quot;)</span>
<span class="sd">            A name which can be optionally given to the molcule for</span>
<span class="sd">            easy identification.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_funcs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                   <span class="s1">&#39;Unable to initialize from &quot;</span><span class="si">{}</span><span class="s1">&quot; files.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_funcs</span><span class="p">[</span><span class="n">ext</span><span class="p">](</span><span class="n">file</span><span class="p">)</span>
        <span class="c1"># Update the property cache of each atom. This updates things</span>
        <span class="c1"># like valence.</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">UpdatePropertyCache</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">note</span><span class="p">)</span>

        <span class="c1"># Define a generator which yields an ``FGInfo`` instance from</span>
        <span class="c1"># `functional_groups`. The yielded ``FGInfo``instance</span>
        <span class="c1"># represents the functional group of the molecule which will</span>
        <span class="c1"># undergo bond formation. The generator determines the</span>
        <span class="c1"># functional group of the molecule from the path of of the</span>
        <span class="c1"># structure file.</span>

        <span class="c1"># The database of precursors should be organized so that any</span>
        <span class="c1"># given structure file has the name of its functional group in</span>
        <span class="c1"># its path. Each file should have the name of only one</span>
        <span class="c1"># functional group in its path. If this is not the case, the</span>
        <span class="c1"># generator will return the functional group which appears</span>
        <span class="c1"># first in `functional_groups`.</span>

        <span class="c1"># Assign the FGInfo instance from `functional_groups` which</span>
        <span class="c1"># describes the functional group provided in `functional_group`</span>
        <span class="c1"># or is found in the path name.</span>
        <span class="k">if</span> <span class="n">functional_group</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">functional_groups</span> <span class="k">if</span>
                                  <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">functional_group</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">functional_groups</span> <span class="k">if</span>
                                  <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">file</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Calling this function labels the atoms in the rdkit molecule</span>
        <span class="c1"># as either atoms which form a bond during reactions or atoms</span>
        <span class="c1"># which get removed.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag_atoms</span><span class="p">()</span>

<div class="viewcode-block" id="StructUnit.init_random"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.init_random">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">init_random</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Picks a random file from `db` to initialize from.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db : str</span>
<span class="sd">            A path to a database of molecular files.</span>

<span class="sd">        fg : str, optional</span>
<span class="sd">            The name of a functional group which the molecules in `db`</span>
<span class="sd">            have. By default it is assumed the name is present in the</span>
<span class="sd">            path of the files.</span>

<span class="sd">        name : str, optional</span>
<span class="sd">            The name to be given to the created molecule.</span>

<span class="sd">        note : str, optional</span>
<span class="sd">            A note to be given to the created molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        StructUnit</span>
<span class="sd">            A random molecule from `db`.</span>

<span class="sd">        None : NoneType</span>
<span class="sd">            If no files in `db` could be initialized from.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">molfile</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">molfile</span><span class="p">,</span> <span class="n">fg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">note</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Could not initialize </span><span class="si">{}</span><span class="s1"> from </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">molfile</span><span class="p">))</span></div>

<div class="viewcode-block" id="StructUnit.all_bonder_distances"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.all_bonder_distances">[docs]</a>    <span class="k">def</span> <span class="nf">all_bonder_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yield distances between all pairs of bonder atoms.</span>

<span class="sd">        All distances are only yielded once. This means that if the</span>
<span class="sd">        distance between atoms with ids ``1`` and ``2``is yielded as</span>
<span class="sd">        ``(12.4, 1, 2)``, no tuple of the form ``(12.4, 2, 1)`` will be</span>
<span class="sd">        yielded.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        tuple of form (int, int, scipy.double)</span>
<span class="sd">            The ints represnt the atoms ids and the double is their</span>
<span class="sd">            distance.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Iterate through each pair of atoms - do not allow</span>
        <span class="c1"># recombinations.</span>
        <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_distance</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span></div>

<div class="viewcode-block" id="StructUnit.bonder_centroid"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.bonder_centroid">[docs]</a>    <span class="k">def</span> <span class="nf">bonder_centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the centroid of the bonder atoms.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            A numpy array holding the midpoint of the bonder atoms.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">centroid</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">centroid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">))</span></div>

<div class="viewcode-block" id="StructUnit.bonder_direction_vectors"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.bonder_direction_vectors">[docs]</a>    <span class="k">def</span> <span class="nf">bonder_direction_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yields the direction vectors between all pairs of bonder atoms.</span>

<span class="sd">        The yielded vector is normalized. If a pair (1,2) is yielded,</span>
<span class="sd">        the pair (2,1) will not be.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        tuple of (int, int, numpy.array)</span>
<span class="sd">            The ints in the tuple represent the ids of the start and</span>
<span class="sd">            end atoms, respectively. The array is the direciont vector</span>
<span class="sd">            running between the atomic positions.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">atom1_id</span><span class="p">,</span> <span class="n">atom2_id</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="n">atom1_id</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="n">atom2_id</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">atom2_id</span><span class="p">,</span> <span class="n">atom1_id</span><span class="p">,</span> <span class="n">normalize_vector</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p2</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructUnit.bonder_position_matrix"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.bonder_position_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">bonder_position_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a matrix holding the positions of bonder atoms.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.matrix</span>
<span class="sd">            The matrix is 3 x n. Each column holds the x, y and z</span>
<span class="sd">            coordinates of a bonder atom. The index of the column</span>
<span class="sd">            corresponds to the index of the atom id in `bonder_ids`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pos_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">for</span> <span class="n">atom_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">:</span>
            <span class="n">pos_vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)])</span>
            <span class="n">pos_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_array</span><span class="p">,</span> <span class="n">pos_vect</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">pos_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructUnit.centroid_centroid_dir_vector"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.centroid_centroid_dir_vector">[docs]</a>    <span class="k">def</span> <span class="nf">centroid_centroid_dir_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the direction vector between the 2 molecular centroids.</span>

<span class="sd">        The first molecule centroid is the centroid of the entire</span>
<span class="sd">        molecule. The second molecular centroid is the centroid of the</span>
<span class="sd">        bonder atoms.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            The normalized direction vector running from the centroid</span>
<span class="sd">            of the bonder atoms to the molecular centroid.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If the bonder centroid and centroid are in the same position,</span>
        <span class="c1"># the centroid - centroid vector should be orthogonal to the</span>
        <span class="c1"># bonder direction vector.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">(),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">bonder_centroid</span><span class="p">(),</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
            <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">bvec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_direction_vectors</span><span class="p">())</span>
            <span class="c1"># Construct a secondary vector by finding the minimum</span>
            <span class="c1"># component of bvec and setting it to 0.</span>
            <span class="n">vec2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bvec</span><span class="p">)</span>
            <span class="n">minc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vec2</span><span class="p">)</span>
            <span class="n">vec2</span><span class="p">[</span><span class="n">vec2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">vec2</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">minc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1e-5</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="c1"># Get a vector orthogonal to bvec and vec2.</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">normalize_vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">bvec</span><span class="p">,</span> <span class="n">vec2</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">a</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">normalize_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span> <span class="o">-</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">bonder_centroid</span><span class="p">())</span></div>

<div class="viewcode-block" id="StructUnit.core"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.core">[docs]</a>    <span class="k">def</span> <span class="nf">core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the molecule with no H or functional group atoms.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The &quot;core&quot; of the molecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">emol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">EditableMol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()):</span>
            <span class="n">atomid</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_core_atom</span><span class="p">(</span><span class="n">atomid</span><span class="p">):</span>
                <span class="n">emol</span><span class="o">.</span><span class="n">RemoveAtom</span><span class="p">(</span><span class="n">atomid</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">emol</span><span class="o">.</span><span class="n">GetMol</span><span class="p">()</span></div>

<div class="viewcode-block" id="StructUnit.functional_group_atoms"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.functional_group_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">functional_group_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a container of atom ids of atoms in functional groups.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple of tuples of ints</span>
<span class="sd">            The form of the returned tuple is:</span>
<span class="sd">            ((1,2,3), (4,5,6), (7,8,9)). This means that all atoms with</span>
<span class="sd">            ids 1 to 9 are in a functional group and that the atoms 1,</span>
<span class="sd">            2 and 3 all form one functional group together. So do 4, 5</span>
<span class="sd">            and 5 and so on.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Generate a ``rdkit.Chem.rdchem.Mol`` instance which</span>
        <span class="c1"># represents the functional group of the molecule.</span>
        <span class="n">func_grp_mol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span><span class="o">.</span><span class="n">fg_smarts</span><span class="p">)</span>

        <span class="c1"># Do a substructure search on the the molecule in `mol` to find</span>
        <span class="c1"># which atoms match the functional group. Return the atom ids</span>
        <span class="c1"># of those atoms.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">func_grp_mol</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructUnit.is_core_atom"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.is_core_atom">[docs]</a>    <span class="k">def</span> <span class="nf">is_core_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``True`` if atom is not H or part of the fg.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atomid : int</span>
<span class="sd">            The id of the atom being queried.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Indicates whether the atom with `atomid` is part of the</span>
<span class="sd">            core.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Tags are removed by multiprocessing - make sure to reapply</span>
        <span class="c1"># them.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_atoms</span><span class="p">()</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">atomid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="s1">&#39;fg&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="StructUnit.json"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.json">[docs]</a>    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a JSON representation of the object.</span>

<span class="sd">        The representation has the following form:</span>

<span class="sd">            {</span>
<span class="sd">                &#39;class&#39; : &#39;StructUnit&#39;,</span>
<span class="sd">                &#39;mol_block&#39; : &#39;A string holding the V3000 mol</span>
<span class="sd">                               block of the molecule.&#39;,</span>
<span class="sd">                &#39;note&#39; : &#39;This molecule is nice.&#39;,</span>
<span class="sd">                &#39;name&#39; : &#39;benzene&#39;</span>
<span class="sd">            }</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dict which represents the molecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>

            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;func_grp&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span> <span class="k">if</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s1">&#39;mol_block&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl_mol_block</span><span class="p">(),</span>
            <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="p">}</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_json_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Completes a JSON initialization.</span>

<span class="sd">        This function is not to be used. Use ``Molecule.load()``</span>
<span class="sd">        for loading instances from a JSON string. That function will</span>
<span class="sd">        automatically call this one.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json_dict : dict</span>
<span class="sd">            A dictionary holding the attribute data of the molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s1">&#39;r+t&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.mol&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;mol_block&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;func_grp&#39;</span><span class="p">],</span>
                      <span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span>
                       <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;load_names&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                      <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">])</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">optimized</span> <span class="o">=</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;optimized&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">obj</span>

<div class="viewcode-block" id="StructUnit.gen_key"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.gen_key">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">gen_key</span><span class="p">(</span><span class="n">rdkit_mol</span><span class="p">,</span> <span class="n">functional_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the key for caching the molecule.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rdkit_mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            An rdkit instance of the molecule.</span>

<span class="sd">        functional_group : str</span>
<span class="sd">            The name of the functional group being used to make</span>
<span class="sd">            macromolecules.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            The key used for caching the molecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">functional_group</span><span class="p">,</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">MolToInchi</span><span class="p">(</span><span class="n">rdkit_mol</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_minimize_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">centroid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate mol to minimize angle between `v1` and `v2`.</span>

<span class="sd">        The rotation is done about the vector `axis`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v1 : numpy.array</span>
<span class="sd">            The vector which is rotated.</span>

<span class="sd">        v2 : numpy.array</span>
<span class="sd">            The vector which is stationary.</span>

<span class="sd">        axis : numpy.array</span>
<span class="sd">            The vector about which the rotation happens.</span>

<span class="sd">        centroid : numpy.array</span>
<span class="sd">            The position vector at the center of the rotation.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The conformer in this rdkit instance is changed due to the</span>
<span class="sd">            rotation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If the vector being rotated is not finite exit. This is</span>
        <span class="c1"># probably due to a planar molecule.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v1</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Save the initial position and change the origin to</span>
        <span class="c1"># `centroid`.</span>
        <span class="n">iposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">centroid</span><span class="p">)</span>

        <span class="c1"># 1. First transform the problem.</span>
        <span class="c1"># 2. The rotation axis is set equal to the z-axis.</span>
        <span class="c1"># 3. Apply this transformation to all vectors in the problem.</span>
        <span class="c1"># 4. Take only the x and y components of `v1` and `v2`.</span>
        <span class="c1"># 5. Work out the angle between them.</span>
        <span class="c1"># 6. Apply that rotation along the original rotation axis.</span>

        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tstart</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tstart</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># If the `tstart` vector is 0 after these transformations it</span>
        <span class="c1"># means that it is parallel to the rotation axis, stop.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">iposition</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">tend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tend</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">vector_theta</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span><span class="p">)</span>

        <span class="c1"># Check in which direction the rotation should go.</span>
        <span class="c1"># This is done by applying the rotation in each direction and</span>
        <span class="c1"># seeing which one leads to a smaller theta.</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">rotation_matrix_arbitrary_axis</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">vector_theta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">tstart</span><span class="p">),</span> <span class="n">tend</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">rotation_matrix_arbitrary_axis</span><span class="p">(</span><span class="o">-</span><span class="n">angle</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">vector_theta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">tstart</span><span class="p">),</span> <span class="n">tend</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">t2</span> <span class="o">&lt;</span> <span class="n">t1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">rotmat</span> <span class="o">=</span> <span class="n">rotation_matrix_arbitrary_axis</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="n">posmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_matrix</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position_from_matrix</span><span class="p">(</span><span class="n">posmat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="n">iposition</span><span class="p">)</span>

<div class="viewcode-block" id="StructUnit.rotate2"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.rotate2">[docs]</a>    <span class="k">def</span> <span class="nf">rotate2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotates the molecule by `theta` about `axis`.</span>

<span class="sd">        The rotation occurs about the centroid of the bonder atoms.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : float</span>
<span class="sd">            The size of the rotation in radians.</span>

<span class="sd">        axis : numpy.array</span>
<span class="sd">            The axis about which rotation happens.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The atoms in this molecule are rotated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Save the origin position of the bonder atom centroid.</span>
        <span class="n">og_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_centroid</span><span class="p">()</span>
        <span class="c1"># Change the position of the centroid of the bonder atoms to</span>
        <span class="c1"># the origin so that the rotation occurs about this point.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bonder_centroid</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Get the rotation matrix.</span>
        <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">rotation_matrix_arbitrary_axis</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="c1"># Apply the rotation on the original atomic coordinates to get</span>
        <span class="c1"># the new ones.</span>
        <span class="n">new_pos_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_matrix</span><span class="p">())</span>
        <span class="c1"># Set the atomic positions to the new coordinates.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position_from_matrix</span><span class="p">(</span><span class="n">new_pos_mat</span><span class="p">)</span>
        <span class="c1"># Return the centroid to its original position.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bonder_centroid</span><span class="p">(</span><span class="n">og_position</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructUnit.set_bonder_centroid"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.set_bonder_centroid">[docs]</a>    <span class="k">def</span> <span class="nf">set_bonder_centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move the molecule so that the bonder centroid is on `position`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        position : numpy.array</span>
<span class="sd">            A numpy array holding the desired the position. It holds</span>
<span class="sd">            the x, y and z coordinates, respectively.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The position of the molecule in this rdkit instance is</span>
<span class="sd">            changed, as described in this docstring.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The rdkit molecule after it has been shifted. The same</span>
<span class="sd">            instance as held in `mol`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_centroid</span><span class="p">()</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">position</span> <span class="o">-</span> <span class="n">center</span>
        <span class="n">new_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>

        <span class="c1"># Make sure the rkdit molecule has only one conformer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">RemoveAllConformers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">AddConformer</span><span class="p">(</span><span class="n">new_conf</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span></div>

    <span class="k">def</span> <span class="nf">_set_orientation2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note: The difference between this method and</span>
<span class="sd">        ``set_orientation()`` is about which point the rotation</span>
<span class="sd">        occurs: centroid of bonder atoms versus centroid of entire</span>
<span class="sd">        molecule, respectively.</span>

<span class="sd">        Given two direction vectors, `start` and `end`, this method</span>
<span class="sd">        applies the rotation required transform `start` to `end` on</span>
<span class="sd">        the molecule. The rotation occurs about the centroid of the</span>
<span class="sd">        molecule.</span>

<span class="sd">        For example, if the `start` and `end` vectors</span>
<span class="sd">        are 45 degrees apart, a 45 degree rotation will be applied to</span>
<span class="sd">        the molecule. The rotation will be along the appropriate</span>
<span class="sd">        direction.</span>

<span class="sd">        The great thing about this method is that you as long as you</span>
<span class="sd">        can associate a gemotric feature of the molecule with a vector,</span>
<span class="sd">        then the molecule can be roatated so that this vector is</span>
<span class="sd">        aligned with `end`. The defined vector can be virtually</span>
<span class="sd">        anything. This means that any geomteric feature of the molecule</span>
<span class="sd">        can be easily aligned with any arbitrary axis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : numpy.array</span>
<span class="sd">            A vector which is to be rotated so that it transforms to</span>
<span class="sd">            the `end` vector.</span>

<span class="sd">        end : numpy.array</span>
<span class="sd">            This array holds the vector, onto which `start` is rotated.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The conformer in this rdkit instance is changed due to</span>
<span class="sd">            rotation of the molecule about its centroid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The rdkit molecule in `mol`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Normalize the input direction vectors.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">normalize_vector</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">normalize_vector</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

        <span class="c1"># Record the position of the molecule then translate the bonder</span>
        <span class="c1"># atom centroid to the origin. This is so that the rotation</span>
        <span class="c1"># occurs about this point.</span>
        <span class="n">og_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_centroid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bonder_centroid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Get the rotation matrix.</span>
        <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="c1"># Apply the rotation matrix to the atomic positions to yield</span>
        <span class="c1"># the new atomic positions.</span>
        <span class="n">new_pos_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_matrix</span><span class="p">())</span>

        <span class="c1"># Set the positions in the rdkit molecule.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_position_from_matrix</span><span class="p">(</span><span class="n">new_pos_mat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bonder_centroid</span><span class="p">(</span><span class="n">og_center</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>

<div class="viewcode-block" id="StructUnit.similar_molecules"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.similar_molecules">[docs]</a>    <span class="k">def</span> <span class="nf">similar_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns molecules from `database` ordered by similarity.</span>

<span class="sd">        The most similar molecule is at index 0.</span>

<span class="sd">        This method uses the Morgan fingerprints of radius 4 to</span>
<span class="sd">        evaluate how similar the molecules in `database` are.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        database : str</span>
<span class="sd">            The full path of the database from which the molecules are</span>
<span class="sd">            checked for similarity.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of tuples of form (float, str)</span>
<span class="sd">            The float is the similarity of a given molecule in the</span>
<span class="sd">            database to `mol` while the str is the full path of the</span>
<span class="sd">            structure file of that molecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First get the fingerprint of `self`.</span>
        <span class="n">rdkit</span><span class="o">.</span><span class="n">GetSSSR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">UpdatePropertyCache</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">GetMorganFingerprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># For every structure file in the database create a rdkit</span>
        <span class="c1"># molecule. Place these in a list.</span>
        <span class="n">mols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="c1"># Ignore files which are not structure files and the</span>
            <span class="c1"># structure file of the molecule itself.</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_funcs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_funcs</span><span class="p">[</span><span class="n">ext</span><span class="p">](</span><span class="n">path</span><span class="p">)</span>
            <span class="n">rdkit</span><span class="o">.</span><span class="n">GetSSSR</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">UpdatePropertyCache</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mol_fp</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">GetMorganFingerprint</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">similarity</span> <span class="o">=</span> <span class="n">DataStructs</span><span class="o">.</span><span class="n">DiceSimilarity</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">mol_fp</span><span class="p">)</span>
            <span class="n">mols</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">similarity</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructUnit.smarts_init"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.smarts_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">smarts_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">smarts</span><span class="p">,</span>
                    <span class="n">functional_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize from a SMARTS string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        smiles : str</span>
<span class="sd">            A SMARTS string of the molecule.</span>

<span class="sd">        functional_group : str (default = None)</span>
<span class="sd">            The name of the functional group which is to have atoms</span>
<span class="sd">            tagged. If no functional group is provided to this</span>
<span class="sd">            parameter, no tagging is done.</span>

<span class="sd">        note : str (default = &quot;&quot;)</span>
<span class="sd">            A note or comment about the molecule.</span>

<span class="sd">        name : str (default = &quot;&quot;)</span>
<span class="sd">            A name which can be optionally given to the molcule for</span>
<span class="sd">            easy identification.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        StructUnit</span>
<span class="sd">            The StructUnit instance of the molecule represented by</span>
<span class="sd">            `smarts`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="n">smarts</span><span class="p">)</span>
        <span class="n">rdkit</span><span class="o">.</span><span class="n">SanitizeMol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">gen_key</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">functional_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">rdkit</span><span class="o">.</span><span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">Molecule</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">smarts</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">func_grp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">functional_groups</span> <span class="k">if</span>
                            <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">functional_group</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">func_grp</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">tag_atoms</span><span class="p">()</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="StructUnit.tag_atoms"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.tag_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">tag_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds bonding and deletion tags to atoms.</span>

<span class="sd">        All atoms which form the functional group of the molecule have</span>
<span class="sd">        the property &#39;fg&#39; added. Its value is set to the name of the</span>
<span class="sd">        functional group.</span>

<span class="sd">        The atoms which form bonds during assembly have the property</span>
<span class="sd">        called &#39;bonder&#39; added and set to &#39;1&#39;. Atoms which are deleted</span>
<span class="sd">        during reactions have the property &#39;del&#39; set to &#39;1&#39;.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The atoms in this rdkit molecule have the properties &#39;fg&#39;,</span>
<span class="sd">            &#39;bonder&#39; and &#39;del&#39; added, in accordance with the docstring.</span>

<span class="sd">        bonder_ids : set of ints</span>
<span class="sd">            Adds the ids of bonder atoms to this list.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Clear this list in case the method is being rerun.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Give all atoms in functional groups the tag &#39;fg&#39; and set its</span>
        <span class="c1"># value to the name of the functional group.</span>
        <span class="k">for</span> <span class="n">atom_id</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">functional_group_atoms</span><span class="p">()):</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s1">&#39;fg&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Give all atoms which form bonds during reactions the tag</span>
        <span class="c1"># &#39;bonder&#39; and set its value to &#39;1&#39;. Add their ids to</span>
        <span class="c1"># `bonder_ids`.</span>
        <span class="n">bond_mol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span><span class="o">.</span><span class="n">bonder_smarts</span><span class="p">)</span>
        <span class="n">bond_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">bond_mol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom_id</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">bond_atoms</span><span class="p">):</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s1">&#39;bonder&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)</span>

        <span class="c1"># Give all atoms which form bonds during reactions the tag</span>
        <span class="c1"># &#39;del&#39; and set its value to &#39;1&#39;.</span>
        <span class="n">del_mol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">MolFromSmarts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_grp</span><span class="o">.</span><span class="n">del_smarts</span><span class="p">)</span>
        <span class="n">del_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetSubstructMatches</span><span class="p">(</span><span class="n">del_mol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom_id</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">del_atoms</span><span class="p">):</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">atom_id</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructUnit.untag_atoms"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit.untag_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">untag_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the tags added by ``tag_atoms()``.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The atoms in this rdkit molecule have the properties</span>
<span class="sd">            &#39;fg&#39;, &#39;bonder&#39; and &#39;del&#39; removed.</span>

<span class="sd">        bonder_ids : list of ints</span>
<span class="sd">            This list is set to [].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">ClearProp</span><span class="p">(</span><span class="s1">&#39;fg&#39;</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">ClearProp</span><span class="p">(</span><span class="s1">&#39;bonder&#39;</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">ClearProp</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="StructUnit2"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit2">[docs]</a><span class="k">class</span> <span class="nc">StructUnit2</span><span class="p">(</span><span class="n">StructUnit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents building blocks with 2 functional groups.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StructUnit2.set_orientation2"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit2.set_orientation2">[docs]</a>    <span class="k">def</span> <span class="nf">set_orientation2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate the molecule so that bonder atoms lie on `end`.</span>

<span class="sd">        The molecule is rotated about the centroid of the bonder atoms.</span>
<span class="sd">        It is rotated so that the direction vector running between the</span>
<span class="sd">        2 bonder atoms is aligned with the vector `end`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        end : numpy.array</span>
<span class="sd">            The vector with which the molecule&#39;s bonder atoms should be</span>
<span class="sd">            aligned.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The conformer in this rdkit instance is changed due to</span>
<span class="sd">            rotation of the molecule about the centroid of the bonder</span>
<span class="sd">            atoms.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The rdkit molecule in `mol`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_direction_vectors</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation2</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructUnit2.minimize_theta"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit2.minimize_theta">[docs]</a>    <span class="k">def</span> <span class="nf">minimize_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotates molecule about `axis` to minimze theta with `vector`.</span>

<span class="sd">        The molecule is rotated about `axis` passing through the bonder</span>
<span class="sd">        centroid. It is rotated so that the vector between the bonder</span>
<span class="sd">        and molecular centroids lies on the same plane as `vector`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vector : numpy.array</span>
<span class="sd">            The vector to which the distance should be minimized.</span>

<span class="sd">        axis : numpy.array</span>
<span class="sd">            The direction vector along which the rotation happens.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The conformer in this rdkit instance is changed due to</span>
<span class="sd">            rotation of the molecule about the centroid of the bonder</span>
<span class="sd">            atoms.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_minimize_theta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centroid_centroid_dir_vector</span><span class="p">(),</span>
                             <span class="n">vector</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_centroid</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="StructUnit3"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit3">[docs]</a><span class="k">class</span> <span class="nc">StructUnit3</span><span class="p">(</span><span class="n">StructUnit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents building blocks with 3 functional groups.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StructUnit3.bonder_plane"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit3.bonder_plane">[docs]</a>    <span class="k">def</span> <span class="nf">bonder_plane</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the coefficients of the plane formed by bonder atoms.</span>

<span class="sd">        A plane is defined by the scalar plane equation,</span>

<span class="sd">            ax + by + cz = d.</span>

<span class="sd">        This method returns the a, b, c and d coefficients of this</span>
<span class="sd">        equation for the plane formed by the bonder atoms. The</span>
<span class="sd">        coefficents a, b and c decribe the normal vector to the plane.</span>
<span class="sd">        The coefficent d is found by substituting these coefficients</span>
<span class="sd">        along with the x, y and z variables in the scalar equation and</span>
<span class="sd">        solving for d. The variables x, y and z are substituted by the</span>
<span class="sd">        coordinate of some point on the plane. For example, the</span>
<span class="sd">        position of one of the bonder atoms.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            This array has the form [a, b, c, d] and represents the</span>
<span class="sd">            scalar equation of the plane formed by the bonder atoms.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        https://tinyurl.com/okpqv6</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bonder_coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_plane_normal</span><span class="p">()</span> <span class="o">*</span> <span class="n">bonder_coord</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_plane_normal</span><span class="p">(),</span> <span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructUnit3.bonder_plane_normal"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit3.bonder_plane_normal">[docs]</a>    <span class="k">def</span> <span class="nf">bonder_plane_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the normal vector to the plane formed by bonder atoms.</span>

<span class="sd">        The normal of the plane is defined such that it goes in the</span>
<span class="sd">        direction toward the centroid of the molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">            A unit vector which describes the normal to the plane of</span>
<span class="sd">            the bonder atoms.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_direction_vectors</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;StructUnit3 molecule &quot;</span>
                             <span class="s2">&quot;has fewer than 3 functional groups.&quot;</span><span class="p">))</span>

        <span class="n">vgen</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_direction_vectors</span><span class="p">())</span>
        <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">vgen</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">normal_v</span> <span class="o">=</span> <span class="n">normalize_vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="n">vector_theta</span><span class="p">(</span><span class="n">normal_v</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">centroid_centroid_dir_vector</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">theta</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">normal_v</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">normal_v</span></div>

<div class="viewcode-block" id="StructUnit3.minimize_theta"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit3.minimize_theta">[docs]</a>    <span class="k">def</span> <span class="nf">minimize_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotates molecule to minimize angle between `atom` and `vector`.</span>

<span class="sd">        The rotation is done about `axis` and is centered on the</span>
<span class="sd">        bonder centroid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom : int</span>
<span class="sd">            The id of atom which is to have angle minimized.</span>

<span class="sd">        vector : numpy.array</span>
<span class="sd">            A vector with which the angle is minimized.</span>

<span class="sd">        axis : numpy.array</span>
<span class="sd">            The vector about which the rotation happens.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The rdkit molecule is changed to reflect the rotation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_coords</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_centroid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimize_theta</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_centroid</span><span class="p">())</span></div>

<div class="viewcode-block" id="StructUnit3.set_orientation2"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.StructUnit3.set_orientation2">[docs]</a>    <span class="k">def</span> <span class="nf">set_orientation2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotates the molecule so the plane normal is aligned with `end`.</span>

<span class="sd">        Here ``plane normal`` referes to the normal of the plane formed</span>
<span class="sd">        by the bonder atoms in the substituted molecule. The molecule</span>
<span class="sd">        is rotated about the centroid of the bonder atoms. The rotation</span>
<span class="sd">        results in the normal of their plane being aligned with `end`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        end : numpy.array</span>
<span class="sd">            The vector with which the normal of plane of bonder atoms</span>
<span class="sd">            shoould be aligned.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The conformer in this rdkit instance is changed due to</span>
<span class="sd">            rotation of the molecule about the centroid of the bonder</span>
<span class="sd">            atoms.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The rdkit molecule in `mol`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_plane_normal</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_orientation2</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MacroMolecule"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.MacroMolecule">[docs]</a><span class="nd">@total_ordering</span>
<span class="k">class</span> <span class="nc">MacroMolecule</span><span class="p">(</span><span class="n">Molecule</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">Cached</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for assembled macromolecules.</span>

<span class="sd">    The goal of this class is to represent an individual used by the</span>
<span class="sd">    GA. As such, it holds attributes that are to be expected for this</span>
<span class="sd">    purpose. Mainly, it has a fitness value stored in its `fitness`</span>
<span class="sd">    attribute and a genetic code - as defined by its `building_blocks`</span>
<span class="sd">    and  `topology` attributes. If a change is made to either of these</span>
<span class="sd">    attributes, they should describe a different macromolecule. On the</span>
<span class="sd">    other hand, the same attributes should always describe the same</span>
<span class="sd">    macromolecule.</span>

<span class="sd">    Because of this, as well as the computational cost associated with</span>
<span class="sd">    macromolecule initialization, instances of this class are cached.</span>
<span class="sd">    This means that providing the same arguments to the initializer</span>
<span class="sd">    will not build a different instance with the same attribute values.</span>
<span class="sd">    It will yield the original instance, retrieved from memory.</span>

<span class="sd">    To prevent bloating this class, any information that can be</span>
<span class="sd">    categorized is. For example, storing information that concerns</span>
<span class="sd">    building blocks ``in a vacuum`` is stored in ``StructUnit``</span>
<span class="sd">    instances. Equally, manipulations of such data is also performed by</span>
<span class="sd">    those instances. Similarly, anything to do with topolgy should be</span>
<span class="sd">    held by a ``Topology`` instance in the topology attribute. There is</span>
<span class="sd">    a notable exception to this however. This happens when retrieving</span>
<span class="sd">    topological information directly from rdkit molecule instances</span>
<span class="sd">    of the macromolecule. Examples include the information about atomic</span>
<span class="sd">    coordinates, which can be access with the ``atom_coords()`` method.</span>

<span class="sd">    It should also be noted that only a single copy of each</span>
<span class="sd">    ``StructUnit`` instance representing a specific building block</span>
<span class="sd">    needs to be held. How many of such building blocks are need to</span>
<span class="sd">    assemble the molecule is the handled by the ``Topology`` class.</span>

<span class="sd">    This class is not intended to be used directly but should be</span>
<span class="sd">    inherited by subclasses representing specific macromolecules. The</span>
<span class="sd">    ``Cage`` and ``Polymer`` classes are examples of this. Any</span>
<span class="sd">    information or methods that apply generally to all macromolecules</span>
<span class="sd">    should be defined within this class while specific non-general data</span>
<span class="sd">    should be included in derived classes.</span>

<span class="sd">    This class also supports comparison operations, these act on the</span>
<span class="sd">    fitness value assiciated with a macromolecule. Comparison</span>
<span class="sd">    operations not explicitly defined are included via the</span>
<span class="sd">    ``total_ordering`` decorator. For other operations and methods</span>
<span class="sd">    supported by this class examine the rest of the class definition.</span>

<span class="sd">    Finally, a word of caution. The equality operator ``==`` compares</span>
<span class="sd">    fitness values. This means two macromolecules, made from different</span>
<span class="sd">    building blocks, can compare equal if they happen to have the same</span>
<span class="sd">    fitness. The operator is not to be used to check if one</span>
<span class="sd">    macromolecule is the same structurally as another. To do this check</span>
<span class="sd">    use the ``same()`` method. This method may be overwritten in</span>
<span class="sd">    derived classes, as necessary. In addition the ``is`` operator is</span>
<span class="sd">    implemented as is default in Python. It compares whether two</span>
<span class="sd">    objects are in the same location in memory. Because the</span>
<span class="sd">    ``MacroMolecule`` class is cached the ``is`` operator could in</span>
<span class="sd">    principle be used instead of the `same` method (including in</span>
<span class="sd">    derived classes). However, this is not intended use and is not</span>
<span class="sd">    guaranteed to work in future implementations. If caching stops</span>
<span class="sd">    being implemented such code would break.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    building_blocks : list of ``StructUnit`` instances</span>
<span class="sd">        This attribute holds ``StructUnit`` instances which represent</span>
<span class="sd">        the monomers forming the macromolecule. Only one ``StructUnit``</span>
<span class="sd">        instance is needed per building block, even if multiples of a</span>
<span class="sd">        building block join up to form the macromolecule</span>

<span class="sd">    bb_counter : Counter</span>
<span class="sd">        A counter keeping track of how much of each building block is</span>
<span class="sd">        used to form the macromolecule.</span>

<span class="sd">    topology : Topology</span>
<span class="sd">        An object of a class derived from ``Topology``. It</span>
<span class="sd">        assembles the marcormolecule from the building_blocks.</span>

<span class="sd">    mol : rdkit.Chem.rdchem.Mol</span>
<span class="sd">        An rdkit instance representing the macromolecule.</span>

<span class="sd">    inchi : str</span>
<span class="sd">        The InChI of the molecule.</span>

<span class="sd">    optimized : bool (default = False)</span>
<span class="sd">        This is a flag to indicate if a molecule has been previously</span>
<span class="sd">        optimized. Optimization functions set this flag to ``True``</span>
<span class="sd">        after an optimization.</span>

<span class="sd">    energy : Energy</span>
<span class="sd">        This attribute handles information about the energy of the</span>
<span class="sd">        instance. See the documentation of ``Energy`` to see what is</span>
<span class="sd">        available.</span>

<span class="sd">    fitness : float (default = None)</span>
<span class="sd">        The fitness value of the macromolecule, as determined by the</span>
<span class="sd">        chosen fitness functions together with any normalization</span>
<span class="sd">        functions. Fitness functions do not place values into this</span>
<span class="sd">        attribute directly.</span>

<span class="sd">    unscaled_fitness : dict</span>
<span class="sd">        The dictionary hold the name of a fitness function as the</span>
<span class="sd">        key and the value it calculated for unscaled_fitness as the</span>
<span class="sd">        value.</span>

<span class="sd">    progress_params : dict (default = {})</span>
<span class="sd">        Holds the fitness parameters which the GA should track to make</span>
<span class="sd">        progress plots. The key is the name of a fitness function.</span>

<span class="sd">    bonds_made : int</span>
<span class="sd">        The number of bonds created during assembly.</span>

<span class="sd">    bonder_ids : list of ints</span>
<span class="sd">        The ids of atoms which have bonds added during assembly. This</span>
<span class="sd">        list is sorted from lowest to highest id.</span>

<span class="sd">    fg_ids : set of ints</span>
<span class="sd">        The ids of atoms which were parth of the functional group of</span>
<span class="sd">        the building blocks.</span>

<span class="sd">    key : MacroMolKey</span>
<span class="sd">        The key used for caching the molecule. Necessary for</span>
<span class="sd">        `update_cache` to work. This attribute is assigned by the</span>
<span class="sd">        `__call__()` method of the ``Cached`` metaclass.</span>

<span class="sd">    name : str (default = &quot;&quot;)</span>
<span class="sd">        A name which can be optionally given to the molcule for easy</span>
<span class="sd">        identification.</span>

<span class="sd">    note : str (default = &quot;&quot;)</span>
<span class="sd">        A note or comment about the molecule. Purely optional but can</span>
<span class="sd">        be useful for labelling and debugging.</span>

<span class="sd">    fragments : dict</span>
<span class="sd">        The key in this dictionary is a tuple of form (int, int). The</span>
<span class="sd">        first int is the index of a building block within</span>
<span class="sd">        `building_blocks`. The second int indentifies a molecule of</span>
<span class="sd">        that building block. For example, (1, 3) identifies the 4th</span>
<span class="sd">        molecule of type building_blocks[1] to be added to the</span>
<span class="sd">        macromolecule during assembly.</span>

<span class="sd">        The value in the dictionary is a set of ints. These hold the</span>
<span class="sd">        atom ids belonging to a particular molecule - before assmebly.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">building_blocks</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a ``MacroMolecule`` instance.</span>

<span class="sd">        When an exception occurs during initialization, all parameters</span>
<span class="sd">        which were provided to the initializer are saved to a file</span>
<span class="sd">        ``failures.txt`` which is in the ``output`` folder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        building_blocks : iterable of ``StructUnit`` instances</span>
<span class="sd">            A set of ``StructUnit`` instances which represent the</span>
<span class="sd">            monomers forming the macromolecule.</span>

<span class="sd">        topology : Topology</span>
<span class="sd">            An instance of a class derived from ``Topology``. It</span>
<span class="sd">            assembles the marcormolecule from the building_blocks.</span>

<span class="sd">        note : str (default = &quot;&quot;)</span>
<span class="sd">            A note or comment about the molecule.</span>

<span class="sd">        name : str (default = &quot;&quot;)</span>
<span class="sd">            A name which can be optionally given to the molcule for</span>
<span class="sd">            easy identification.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unscaled_fitness</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">building_blocks</span> <span class="o">=</span> <span class="n">building_blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bb_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fg_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds_made</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Ask the ``Topology`` instance to assemble/build the</span>
            <span class="c1"># macromolecule. This creates the `mol` attribute.</span>
            <span class="n">topology</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">Mol</span><span class="p">()</span>
            <span class="n">errormsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Build failure.</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;topology</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;--------</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;building blocks</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;---------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>

            <span class="n">bb_blocks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="n">building_blocks</span><span class="p">:</span>
                <span class="n">bb_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.__class__.__name__}</span><span class="s1"> </span><span class="si">{0.func_grp.name}</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">bb</span><span class="o">.</span><span class="n">mdl_mol_block</span><span class="p">()))</span>

            <span class="n">errormsg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bb_blocks</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errormsg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">note</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_ids</span><span class="p">()</span>

<div class="viewcode-block" id="MacroMolecule.building_block_cores"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.MacroMolecule.building_block_cores">[docs]</a>    <span class="k">def</span> <span class="nf">building_block_cores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yields the &quot;cores&quot; of a building block molecule.</span>

<span class="sd">        The structure of the cores are representative of how they are</span>
<span class="sd">        found in the macromolecule.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bb : int</span>
<span class="sd">            The index of a building block molecule within</span>
<span class="sd">            `building_blocks`. The cores of this molecule are yielded.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        rdkit.Chem.rdchem.Mol</span>
<span class="sd">            The core of a building block molecule, as found in the</span>
<span class="sd">            macromolecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">bb_index</span><span class="p">,</span> <span class="n">mol_index</span><span class="p">),</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Ignore fragments which do not correspond to the molecule</span>
            <span class="c1"># `bb`.</span>
            <span class="k">if</span> <span class="n">bb_index</span> <span class="o">!=</span> <span class="n">bb</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># For each fragment make a new core. To preserver bond</span>
            <span class="c1"># information, start with the macromolecule.</span>
            <span class="n">coremol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">EditableMol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
            <span class="c1"># Remove any atoms not part of the core - atoms not in the</span>
            <span class="c1"># fragment itself, hydrogens, atoms in the functional</span>
            <span class="c1"># group.</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()):</span>
                <span class="n">atomid</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">atomid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="ow">or</span>
                    <span class="n">atomid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_ids</span> <span class="ow">or</span>
                   <span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">coremol</span><span class="o">.</span><span class="n">RemoveAtom</span><span class="p">(</span><span class="n">atomid</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">coremol</span><span class="o">.</span><span class="n">GetMol</span><span class="p">()</span></div>

<div class="viewcode-block" id="MacroMolecule.json"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.MacroMolecule.json">[docs]</a>    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a JSON representation of the object.</span>

<span class="sd">        The representation has the following form:</span>

<span class="sd">            {</span>
<span class="sd">                &#39;class&#39; : &#39;Polymer&#39;,</span>
<span class="sd">                &#39;mol_block&#39; : &#39;A string holding the V3000 mol</span>
<span class="sd">                               block of the molecule.&#39;</span>
<span class="sd">                &#39;building_blocks&#39; : {bb1.json(), bb2.json()}</span>
<span class="sd">                &#39;topology&#39; : &#39;Copolymer(repeating_unit=&#39;AB&#39;)&#39;</span>
<span class="sd">                &#39;unscaled_fitness&#39; : {&#39;fitness_func1&#39; : fitness1,</span>
<span class="sd">                                      &#39;fitness_func2&#39; : fitness2},</span>
<span class="sd">                &#39;note&#39; : &#39;A nice molecule.&#39;,</span>
<span class="sd">                &#39;name&#39; : &#39;Poly-Benzene&#39;</span>
<span class="sd">            }</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dict which represents the molecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;bb_counter&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">key</span><span class="o">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">bb_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
            <span class="s1">&#39;bonds_made&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds_made</span><span class="p">,</span>
            <span class="s1">&#39;bonder_ids&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">,</span>
            <span class="s1">&#39;fg_ids&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fg_ids</span><span class="p">),</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;mol_block&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl_mol_block</span><span class="p">(),</span>
            <span class="s1">&#39;building_blocks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">building_blocks</span><span class="p">],</span>
            <span class="s1">&#39;topology&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">),</span>
            <span class="s1">&#39;unscaled_fitness&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unscaled_fitness</span><span class="p">),</span>
            <span class="s1">&#39;progress_params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_params</span><span class="p">,</span>
            <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;fragments&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                          <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                          <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

        <span class="p">}</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_json_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Completes a JSON initialization.</span>

<span class="sd">        This function is not to be used. Use ``Molecule.load()``</span>
<span class="sd">        for loading instances from a JSON string. That function will</span>
<span class="sd">        automatically call this one.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json_dict : dict</span>
<span class="sd">            A dictionary holding the attribute data of the molecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Molecule</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
               <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;building_blocks&#39;</span><span class="p">]]</span>

        <span class="n">topology</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;topology&#39;</span><span class="p">],</span>  <span class="n">topologies</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">gen_key</span><span class="p">(</span><span class="n">bbs</span><span class="p">,</span> <span class="n">topology</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">MolFromMolBlock</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;mol_block&#39;</span><span class="p">],</span>
                                        <span class="n">sanitize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">removeHs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">unscaled_fitness</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;unscaled_fitness&#39;</span><span class="p">],</span>
                                    <span class="n">np</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">fitness</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">progress_params</span> <span class="o">=</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;progress_params&#39;</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">bb_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">({</span><span class="n">Molecule</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="n">val</span> <span class="k">for</span>
                                  <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;bb_counter&#39;</span><span class="p">]})</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">bonds_made</span> <span class="o">=</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;bonds_made&#39;</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">Energy</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">bonder_ids</span> <span class="o">=</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;bonder_ids&#39;</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">fg_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;fg_ids&#39;</span><span class="p">])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">optimized</span> <span class="o">=</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;optimized&#39;</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;load_names&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">building_blocks</span> <span class="o">=</span> <span class="n">bbs</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">fragments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
             <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;fragments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;fragments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="p">))</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">return</span> <span class="n">obj</span>

<div class="viewcode-block" id="MacroMolecule.gen_key"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.MacroMolecule.gen_key">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">gen_key</span><span class="p">(</span><span class="n">building_blocks</span><span class="p">,</span> <span class="n">topology</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the key for caching the molecule.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        building_blocks : iterable of StructUnit instances</span>
<span class="sd">            The building blocks used to make the macromolecule.</span>

<span class="sd">        topology : Topology</span>
<span class="sd">            The topology used to make the macromolecule.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            The key used for caching the macromolecule.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">building_blocks</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">topology</span><span class="p">))</span></div>

<div class="viewcode-block" id="MacroMolecule.bb_distortion"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.MacroMolecule.bb_distortion">[docs]</a>    <span class="k">def</span> <span class="nf">bb_distortion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rmsd difference of building blocks before and after assembly.</span>

<span class="sd">        The function looks at each building block in the macromolecule</span>
<span class="sd">        and calculates the rmsd between the &quot;free&quot; verson and the one</span>
<span class="sd">        present in the macromolecule. The mean of these rmsds is</span>
<span class="sd">        returned.</span>

<span class="sd">        Atoms which form the functional group of the building blocks</span>
<span class="sd">        and hydrogens are excluded from the calculation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The mean rmsd of the macromole&#39;s building blocks to their</span>
<span class="sd">            &quot;free&quot; counterparts.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Go through each of the building blocks. For each building</span>
        <span class="c1"># block get the core. Get the corrospending cores in the</span>
        <span class="c1"># macromolecules and add the rmsd to the sum. Increment the</span>
        <span class="c1"># count to calculate the mean later.</span>
        <span class="n">rmsd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">building_blocks</span><span class="p">):</span>
            <span class="n">free</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">core</span><span class="p">()</span>
            <span class="n">am</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">free</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">())]</span>
            <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">building_block_cores</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">rmsd</span> <span class="o">+=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">AlignMol</span><span class="p">(</span><span class="n">free</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">atomMap</span><span class="o">=</span><span class="n">am</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">rmsd</span> <span class="o">/</span> <span class="n">n</span></div>

<div class="viewcode-block" id="MacroMolecule.save_ids"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.MacroMolecule.save_ids">[docs]</a>    <span class="k">def</span> <span class="nf">save_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates `bonder_ids` and `fg_ids` attributes.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        bonder_ids : list of ints</span>
<span class="sd">            All molecules tagged &#39;bonder&#39; have their ids added to this</span>
<span class="sd">            list.</span>

<span class="sd">        fg_ids : set of ints</span>
<span class="sd">            All molecules tagged &#39;fg&#39; have their ids add to</span>
<span class="sd">            this set.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fg_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="s1">&#39;bonder&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="s1">&#39;fg&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fg_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">)</span></div>

<div class="viewcode-block" id="MacroMolecule.update_cache"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.MacroMolecule.update_cache">[docs]</a>    <span class="k">def</span> <span class="nf">update_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set cached molecule with same &#39;key&#39; to have equal attributes.</span>

<span class="sd">        When an instance of ``MacroMolecule`` is first created it</span>
<span class="sd">        is cached. Using multiprocessing to perform optimizations or</span>
<span class="sd">        calculate fitness returns modified copies of the cached</span>
<span class="sd">        molecules. In order to ensure that the cached molecules have</span>
<span class="sd">        their attributes updated to the values of the copies, this</span>
<span class="sd">        method must be run on the copies.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

<div class="viewcode-block" id="MacroMolecule.update_fragments"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.MacroMolecule.update_fragments">[docs]</a>    <span class="k">def</span> <span class="nf">update_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves rdkit atom properties in `fragments`.</span>

<span class="sd">        The properties saved are &#39;bb_index&#39; and &#39;mol_index&#39;. These</span>
<span class="sd">        should be added to the atoms by the ``place_mols()`` function</span>
<span class="sd">        during ``build()``.</span>

<span class="sd">        Modifies</span>
<span class="sd">        --------</span>
<span class="sd">        fragments : dict</span>
<span class="sd">            The dictionary is updated with the data from the &#39;bb_index&#39;</span>
<span class="sd">            and &#39;mol_index&#39; properties.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="s1">&#39;bb_index&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">molkey</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="s1">&#39;bb_index&#39;</span><span class="p">)),</span>
                      <span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="s1">&#39;mol_index&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">molkey</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">fitness</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">fitness</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(building_blocks=</span><span class="si">{}</span><span class="s2">, topology=</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">building_blocks</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The following methods are inteded for convenience while</span>
<span class="sd">    debugging or testing and should not be used during typical</span>
<span class="sd">    execution of the program.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MacroMolecule.testing_init"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.MacroMolecule.testing_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">testing_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bb1</span><span class="p">,</span> <span class="n">bb2</span><span class="p">,</span> <span class="n">topology</span><span class="p">):</span>

        <span class="n">key</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="n">bb1</span><span class="p">,</span> <span class="n">bb2</span><span class="p">}),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">MacroMolecule</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">MacroMolecule</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">macro_mol</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="n">macro_mol</span><span class="o">.</span><span class="n">building_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">bb1</span><span class="p">,</span> <span class="n">bb2</span><span class="p">]</span>
            <span class="n">macro_mol</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span>
            <span class="n">MacroMolecule</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">macro_mol</span>
            <span class="k">return</span> <span class="n">macro_mol</span></div></div>


<div class="viewcode-block" id="Cage"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Cage">[docs]</a><span class="k">class</span> <span class="nc">Cage</span><span class="p">(</span><span class="n">MacroMolecule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to represent molecular cages.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Cage.window_difference"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Cage.window_difference">[docs]</a>    <span class="k">def</span> <span class="nf">window_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The total difference in all window sizes.</span>

<span class="sd">        Every combination of windows is considered and all the</span>
<span class="sd">        size differences are summed and returned. Only</span>
<span class="sd">        differences between windows of the same type are</span>
<span class="sd">        considered.</span>

<span class="sd">        Consider a triangular-based prism cage topology. Such a</span>
<span class="sd">        cage will have triangular windows and square windows. You</span>
<span class="sd">        only want to compare the triangulars with other</span>
<span class="sd">        triangular windows and squares only with other squares.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The total difference of window size when considering</span>
<span class="sd">            every combination of windows of the same type.</span>

<span class="sd">        None : NoneType</span>
<span class="sd">            If not all windows were found.</span>


<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        WindowError</span>
<span class="sd">            When the number of found windows is less than the</span>
<span class="sd">            number of expected windows. Likely due to a collapsed</span>
<span class="sd">            cage.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windows</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">n_windows</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Cluster the windows into groups so that only size</span>
        <span class="c1"># differences between windows of the same type are taken</span>
        <span class="c1"># into account. To do this, first sort the windows by</span>
        <span class="c1"># size. If two windows types are present split the</span>
        <span class="c1"># windows at the two groups at the point where the window</span>
        <span class="c1"># sizes have the biggest difference. If there are three</span>
        <span class="c1"># types split it at the two biggest differences and so</span>
        <span class="c1"># on.</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">)</span>

        <span class="n">diffs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">windows</span><span class="p">)))</span>
        <span class="n">sorted_diffs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">diffs</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get indices of where the list should be split.</span>
        <span class="n">split</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">n_window_types</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">diffs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sorted_diffs</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Get the sub-lists.</span>
        <span class="n">og</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
            <span class="n">og</span> <span class="o">=</span> <span class="n">og</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">n_window_types</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">og</span><span class="p">)</span>

        <span class="c1"># After this sum the differences in each group and then</span>
        <span class="c1"># sum the group totals.</span>
        <span class="n">diff_sums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="n">diff_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w1</span> <span class="o">-</span> <span class="n">w2</span><span class="p">)</span> <span class="k">for</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="ow">in</span>
                                    <span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

            <span class="n">diff_num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                <span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

            <span class="n">diff_sums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff_sum</span> <span class="o">/</span> <span class="n">diff_num</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">diff_sums</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">windows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns window sizes found by pyWindow.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>
<span class="sd">            If the function for finding windows and their sizes</span>
<span class="sd">            found fewer than the required number of windows or</span>
<span class="sd">            if it failed for some other reason.</span>

<span class="sd">        list of floats</span>
<span class="sd">            Each float in the list represents the size of a</span>
<span class="sd">            window in the cage. If the window finding function</span>
<span class="sd">            found more than the expected number of windows, only</span>
<span class="sd">            the largest n windows are returned. Where n is the</span>
<span class="sd">            number of expected windows.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="c1"># Load an RDKit molecule object to pyWINDOW.</span>
            <span class="n">pw_molecule</span> <span class="o">=</span> <span class="n">pywindow</span><span class="o">.</span><span class="n">molecular</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">load_rdkit_mol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
            <span class="c1"># Find windows and get a single array with windows&#39; sizes.</span>
            <span class="n">all_windows</span> <span class="o">=</span> <span class="n">pw_molecule</span><span class="o">.</span><span class="n">calculate_windows</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;windows&#39;</span><span class="p">)</span>

        <span class="c1"># If pyWindow failed, return ``None``.</span>
        <span class="k">if</span> <span class="n">all_windows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">all_windows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_windows</span><span class="p">,</span>
                             <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">n_windows</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_windows</span><span class="p">):</span>
            <span class="c1"># Return ``None`` when pyWindow fucks up and outputs</span>
            <span class="c1"># a mistakenly large window size.</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">all_windows</span></div>


<div class="viewcode-block" id="Polymer"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Polymer">[docs]</a><span class="k">class</span> <span class="nc">Polymer</span><span class="p">(</span><span class="n">MacroMolecule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to represent polymers.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="Cell"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Cell">[docs]</a><span class="k">class</span> <span class="nc">Cell</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">bonders</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonders</span> <span class="o">=</span> <span class="n">bonders</span></div>


<div class="viewcode-block" id="Periodic"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Periodic">[docs]</a><span class="k">class</span> <span class="nc">Periodic</span><span class="p">(</span><span class="n">MacroMolecule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to represent periodic structures.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    terminator_coords : :class:`dict`</span>
<span class="sd">        The key is an :class:`int` representing the index of a bonder</span>
<span class="sd">        atom within :attr:`.bonder_ids`. The value is a</span>
<span class="sd">        :class:`numpy.ndarray` which holds the x, y and z coordinates</span>
<span class="sd">        of a deleter atom attached to the bonder. The coordinates</span>
<span class="sd">        are relative to the bonder atom.</span>

<span class="sd">        The index must be used rather than the bonder id itself</span>
<span class="sd">        because this dictionary is filled before atoms are deleted</span>
<span class="sd">        during assembly. After deletion, ids of the remaining atoms</span>
<span class="sd">        change and as a result if this dictionary saved the ids it</span>
<span class="sd">        would be inaccurate by the time :meth:`.Topology.build`</span>
<span class="sd">        completed.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_is_subterminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_id</span><span class="p">,</span> <span class="n">bonder_map</span><span class="p">,</span> <span class="n">bonded</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">atom_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bonder_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">bid</span> <span class="o">=</span> <span class="n">bonder_map</span><span class="p">[</span><span class="n">atom_id</span><span class="p">]</span>
        <span class="n">periodic</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">atom1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">connections</span><span class="p">}</span>
        <span class="n">periodic</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">atom2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">connections</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">periodic</span> <span class="ow">or</span> <span class="n">atom_id</span> <span class="ow">in</span> <span class="n">bonded</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Periodic.island"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Periodic.island">[docs]</a>    <span class="k">def</span> <span class="nf">island</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">terminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bond_type</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">):</span>
        <span class="n">cells</span><span class="p">,</span> <span class="n">island</span><span class="p">,</span> <span class="n">bonder_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_place_island</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="n">island</span><span class="p">,</span> <span class="n">bonded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_island</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="n">island</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_island</span><span class="p">(</span><span class="n">island</span><span class="p">,</span> <span class="n">bonded</span><span class="p">,</span> <span class="n">bonder_map</span><span class="p">,</span>
                                      <span class="n">terminator</span><span class="p">,</span> <span class="n">bond_dict</span><span class="p">[</span><span class="n">bond_type</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_join_island</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">island</span><span class="p">):</span>
        <span class="n">emol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">EditableMol</span><span class="p">(</span><span class="n">island</span><span class="p">)</span>
        <span class="n">bonded</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
                <span class="c1"># ccel as in &quot;connected cell&quot;.</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="n">connection</span><span class="o">.</span><span class="n">direction1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ccell</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">z</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">b1id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">[</span><span class="n">connection</span><span class="o">.</span><span class="n">atom1</span><span class="p">]</span>
                <span class="n">bonder1</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">bonders</span><span class="p">[</span><span class="n">b1id</span><span class="p">]</span>
                <span class="n">b2id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">[</span><span class="n">connection</span><span class="o">.</span><span class="n">atom2</span><span class="p">]</span>
                <span class="n">bonder2</span> <span class="o">=</span> <span class="n">ccell</span><span class="o">.</span><span class="n">bonders</span><span class="p">[</span><span class="n">b2id</span><span class="p">]</span>
                <span class="n">bond_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">determine_bond_type</span><span class="p">(</span>
                              <span class="bp">self</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">[</span><span class="n">connection</span><span class="o">.</span><span class="n">atom1</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">[</span><span class="n">connection</span><span class="o">.</span><span class="n">atom2</span><span class="p">])</span>
                <span class="n">emol</span><span class="o">.</span><span class="n">AddBond</span><span class="p">(</span><span class="n">bonder1</span><span class="p">,</span> <span class="n">bonder2</span><span class="p">,</span> <span class="n">bond_type</span><span class="p">)</span>
                <span class="n">bonded</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bonder1</span><span class="p">)</span>
                <span class="n">bonded</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bonder2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">emol</span><span class="o">.</span><span class="n">GetMol</span><span class="p">(),</span> <span class="n">bonded</span>

    <span class="k">def</span> <span class="nf">_terminate_island</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">island</span><span class="p">,</span> <span class="n">bonded</span><span class="p">,</span>
                          <span class="n">bonder_map</span><span class="p">,</span> <span class="n">terminator</span><span class="p">,</span> <span class="n">bond_type</span><span class="p">):</span>

        <span class="n">iconf</span> <span class="o">=</span> <span class="n">island</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>
        <span class="n">emol</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">EditableMol</span><span class="p">(</span><span class="n">island</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">island</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
            <span class="n">atom_id</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_subterminal</span><span class="p">(</span><span class="n">atom_id</span><span class="p">,</span> <span class="n">bonder_map</span><span class="p">,</span> <span class="n">bonded</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">emol</span><span class="o">.</span><span class="n">AddAtom</span><span class="p">(</span><span class="n">rdkit</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="n">terminator</span><span class="p">))</span>
            <span class="n">emol</span><span class="o">.</span><span class="n">AddBond</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">atom_id</span><span class="p">,</span> <span class="n">bond_type</span><span class="p">)</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bonder_map</span><span class="p">[</span><span class="n">atom_id</span><span class="p">])</span>
            <span class="n">tcoords</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">iconf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">atom_id</span><span class="p">))</span> <span class="o">+</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">terminator_coords</span><span class="p">[</span><span class="n">bi</span><span class="p">])</span>
            <span class="n">rdkit_coords</span> <span class="o">=</span> <span class="n">rdkit_geo</span><span class="o">.</span><span class="n">Point3D</span><span class="p">(</span><span class="o">*</span><span class="n">tcoords</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdkit_coords</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="n">emol</span><span class="o">.</span><span class="n">GetMol</span><span class="p">()</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atom_id</span><span class="p">,</span> <span class="n">atom_coords</span> <span class="ow">in</span> <span class="n">coords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">SetAtomPosition</span><span class="p">(</span><span class="n">atom_id</span><span class="p">,</span> <span class="n">atom_coords</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mol</span>

    <span class="k">def</span> <span class="nf">_place_island</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">cell_dimensions</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">island</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">Mol</span><span class="p">()</span>
        <span class="n">bonder_map</span> <span class="o">=</span> <span class="n">ChainMap</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">island</span> <span class="o">=</span> <span class="n">rdkit</span><span class="o">.</span><span class="n">CombineMols</span><span class="p">(</span>
                                <span class="n">island</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">bonders</span> <span class="o">=</span> <span class="p">{</span><span class="n">bi</span><span class="p">:</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span> <span class="o">+</span> <span class="n">bi</span> <span class="k">for</span>
                               <span class="n">bi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonder_ids</span><span class="p">}</span>
                    <span class="n">inverse_bonders</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bonders</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                               <span class="n">bonders</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">bonder_map</span> <span class="o">=</span> <span class="n">bonder_map</span><span class="o">.</span><span class="n">new_child</span><span class="p">(</span><span class="n">inverse_bonders</span><span class="p">)</span>
                    <span class="n">cells</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cell</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">bonders</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">cells</span><span class="p">,</span> <span class="n">island</span><span class="p">,</span> <span class="n">bonder_map</span>

<div class="viewcode-block" id="Periodic.write"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Periodic.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gin&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_gulp_input</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_write_gulp_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="o">...</span>


<div class="viewcode-block" id="Periodic.write_island"><a class="viewcode-back" href="../../../mmead.molecular.html#mmead.molecular.molecules.Periodic.write_island">[docs]</a>    <span class="k">def</span> <span class="nf">write_island</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="o">...</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Lukas Turcani.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>